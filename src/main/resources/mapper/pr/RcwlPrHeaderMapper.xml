<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="org.srm.purchasecooperation.cux.pr.infra.mapper.RcwlPrHeaderMapper">
    <!-- 可根据自己的需求，是否要使用 -->
    <select id="selectForMaintain" parameterType="org.srm.purchasecooperation.pr.api.dto.PrHeaderDTO"
            resultType="org.srm.purchasecooperation.pr.domain.vo.PrHeaderVO">
        <bind name="userDetails" value="@io.choerodon.core.oauth.DetailsHelper@getUserDetails()"/>
        <bind name="lang" value="@io.choerodon.mybatis.helper.LanguageHelper@language()"/>
        SELECT
        <include refid="Base_Column_List"/>
        ,
        scbl.company_name,
        hou.ou_name,
        hpo.organization_name AS purchase_org_name,
        hpa.purchase_agent_name,
        iur.login_name as pr_requested_num,
        iuz.real_name as create_by_name,
        sph.invoice_company_id,
        iscbl.company_name as invoice_company_name,
        sptl.pr_type_name,
        spt.pr_type_code,
        sph.pr_type_id
        FROM
        sprm_pr_header sph
        LEFT JOIN hpfm_company hc ON sph.company_id = hc.company_id
        LEFT JOIN (SELECT MAX(version_number) version_number,company_id FROM spfm_company_basic WHERE process_status = 'COMPLETE' GROUP BY company_id) scba_max
        on scba_max.company_id=hc.source_key
        LEFT JOIN spfm_company_basic scb ON scb.company_id = scba_max.company_id AND scba_max.version_number = scb.version_number
        LEFT JOIN spfm_company_basic_tl scbl ON scb.company_basic_id = scbl.company_basic_id
        AND scbl.lang = #{lang}
        LEFT JOIN hpfm_company ihc ON sph.invoice_company_id = ihc.company_id
        LEFT JOIN (SELECT MAX(version_number) version_number,company_id FROM spfm_company_basic WHERE process_status = 'COMPLETE' GROUP BY company_id) iscba_max
        on iscba_max.company_id=ihc.source_key
        LEFT JOIN spfm_company_basic iscb ON iscb.company_id = iscba_max.company_id AND iscba_max.version_number = iscb.version_number
        LEFT JOIN spfm_company_basic_tl iscbl ON iscb.company_basic_id = iscbl.company_basic_id
        AND iscbl.lang = #{lang}
        LEFT JOIN hpfm_operation_unit hou ON sph.ou_id = hou.ou_id
        LEFT JOIN hpfm_purchase_organization hpo ON sph.purchase_org_id = hpo.purchase_org_id
        LEFT JOIN hpfm_purchase_agent hpa ON sph.purchase_agent_id = hpa.purchase_agent_id
        LEFT JOIN iam_user iuz ON iuz.id = sph.created_by
        LEFT JOIN iam_user iur ON iur.id = sph.requested_by
        LEFT JOIN sprm_pr_type spt ON sph.pr_type_id = spt.pr_type_id
        LEFT JOIN sprm_pr_type_tl sptl ON sptl.pr_type_id = spt.pr_type_id AND sptl.lang = #{lang}
        WHERE
        1 = 1
        <!--        <if test="userDetails != null">-->
        <!--            AND sph.created_by = #{userDetails.userId,jdbcType=DECIMAL}-->
        <!--        </if>-->
        <if test="purchasePlatformQueryParam1 != null and purchasePlatformQueryParam1 != ''">
            <bind name="purchasePlatformQueryParam1Like" value="'%'+purchasePlatformQueryParam1 +'%'"/>
            AND (sph.display_pr_num LIKE #{purchasePlatformQueryParam1Like}
                    OR sph.title LIKE #{purchasePlatformQueryParam1Like}
                    OR iuz.real_name LIKE #{purchasePlatformQueryParam1Like})
        </if>
        <choose>
            <when test="prStatusCode != null and prStatusCode != ''">
                AND sph.pr_status_code = #{prStatusCode}
            </when>
            <otherwise>
                <if test="prStatusCodeList != null and prStatusCodeList.size() gt 0">
                    AND sph.pr_status_code IN
                    <foreach collection="prStatusCodeList" item="statusCode" open="(" close=")" separator=",">
                        #{statusCode}
                    </foreach>
                </if>
            </otherwise>
        </choose>
        <if test="tenantId != null">
            AND sph.tenant_id = #{tenantId}
        </if>
        <if test="displayPrNum != null and displayPrNum != ''">
            <bind name="displayPrNumLike" value="'%'+displayPrNum +'%'"/>
            AND sph.display_pr_num LIKE #{displayPrNumLike}
        </if>
        <if test="requestDateStart != null">
            AND sph.request_date &gt;= #{requestDateStart}
        </if>
        <if test="requestDateEnd != null">
            AND sph.request_date &lt;= #{requestDateEnd}
        </if>
        <if test="prRequestedName != null and prRequestedName != ''">
            <bind name="prRequestedNameLike" value="'%'+prRequestedName +'%'"/>
            AND sph.pr_requested_name LIKE #{prRequestedNameLike}
        </if>
        <if test="purchaseAgentId != null">
            AND sph.purchase_agent_id = #{purchaseAgentId}
        </if>
        <if test="purchaseAgentName != null and purchaseAgentName != ''">
            <bind name="purchaseAgentNameLike" value="'%'+purchaseAgentName +'%'"/>
            AND hpa.purchase_agent_name LIKE #{purchaseAgentNameLike}
        </if>
        <if test="prSourcePlatform != null and prSourcePlatform != ''">
            AND sph.pr_source_platform = #{prSourcePlatform}
        </if>
        AND sph.pr_source_platform != 'ERP'
        <if test="closeStatusCode != null and closeStatusCode != ''">
            AND sph.close_status_code = #{closeStatusCode}
        </if>
        <choose>
            <when test="cancelStatusCode != null and cancelStatusCode != ''">
                AND sph.cancel_status_code = #{cancelStatusCode}
            </when>
            <otherwise>
                <if test="prCancelStatusList != null and prCancelStatusList.size() gt 0">
                    AND sph.cancel_status_code IN
                    <foreach collection="prCancelStatusList" item="statusCode" open="(" close=")" separator=",">
                        #{statusCode}
                    </foreach>
                </if>
            </otherwise>
        </choose>
        <if test="creationDateFrom !=null">
            AND sph.creation_date >= #{creationDateFrom}
        </if>
        <if test="creationDateTo !=null">
            AND sph.creation_date &lt; #{creationDateTo}
        </if>
        <if test="lotNum != null">
            AND sph.lot_num = #{lotNum}
        </if>
        <if test="unitId != null">
            AND sph.unit_id = #{unitId}
        </if>
        <if test="title != null and title != ''">
            <bind name="titleLike" value="'%'+title+'%'"/>
            AND sph.title LIKE #{titleLike}
        </if>
        <if test="companyId != null">
            AND sph.company_id = #{companyId}
        </if>
        <if test="ouId != null">
            AND sph.ou_id = #{ouId}
        </if>
        <if test="purchaseOrgId != null">
            AND sph.purchase_org_id = #{purchaseOrgId}
        </if>
        <if test="invoiceCompanyId != null">
            AND sph.invoice_company_id = #{invoiceCompanyId}
        </if>
        <if test="changedFlag != null">
            AND sph.changed_flag = #{changedFlag}
        </if>
        <if test=" prTypeId!= null">
            AND sph.pr_type_id = #{prTypeId}
        </if>
    </select>

    <resultMap id="BaseResultMap" type="org.srm.purchasecooperation.pr.domain.entity.PrHeader">
        <result column="pr_header_id" property="prHeaderId" jdbcType="DECIMAL"/>
        <result column="tenant_id" property="tenantId" jdbcType="DECIMAL"/>
        <result column="pr_num" property="prNum" jdbcType="VARCHAR"/>
        <result column="display_pr_num" property="displayPrNum" jdbcType="VARCHAR"/>
        <result column="pr_status_code" property="prStatusCode" jdbcType="VARCHAR"/>
        <result column="previous_pr_status_code" property="previousPrStatusCode" jdbcType="VARCHAR"/>
        <result column="title" property="title" jdbcType="VARCHAR"/>
        <result column="request_date" property="requestDate" jdbcType="DATE"/>
        <result column="amount" property="amount" jdbcType="DECIMAL"/>
        <result column="freight" property="freight" jdbcType="DECIMAL"/>
        <result column="payment_method_code" property="paymentMethodCode" jdbcType="VARCHAR"/>
        <result column="payment_method_name" property="paymentMethodName" jdbcType="VARCHAR"/>
        <result column="requested_by" property="requestedBy" jdbcType="DECIMAL"/>
        <result column="pr_requested_name" property="prRequestedName" jdbcType="VARCHAR"/>
        <result column="contact_tel_num" property="contactTelNum" jdbcType="VARCHAR"/>
        <result column="company_id" property="companyId" jdbcType="DECIMAL"/>
        <result column="ou_id" property="ouId" jdbcType="DECIMAL"/>
        <result column="purchase_org_id" property="purchaseOrgId" jdbcType="DECIMAL"/>
        <result column="purchase_agent_id" property="purchaseAgentId" jdbcType="DECIMAL"/>
        <result column="pr_source_platform" property="prSourcePlatform" jdbcType="VARCHAR"/>
        <result column="lot_num" property="lotNum" jdbcType="VARCHAR"/>
        <result column="receiver_address" property="receiverAddress" jdbcType="VARCHAR"/>
        <result column="receiver_address_id" property="receiverAddressId" jdbcType="DECIMAL"/>
        <result column="receiver_region_id" property="receiverRegionId" jdbcType="DECIMAL"/>
        <result column="receiver_contact_name" property="receiverContactName" jdbcType="VARCHAR"/>
        <result column="receiver_tel_num" property="receiverTelNum" jdbcType="VARCHAR"/>
        <result column="receiver_email_address" property="receiverEmailAddress" jdbcType="VARCHAR"/>
        <result column="invoice_address" property="invoiceAddress" jdbcType="VARCHAR"/>
        <result column="invoice_address_id" property="invoiceAddressId" jdbcType="DECIMAL"/>
        <result column="invoice_region_id" property="invoiceRegionId" jdbcType="DECIMAL"/>
        <result column="invoice_contact_name" property="invoiceContactName" jdbcType="VARCHAR"/>
        <result column="invoice_tel_num" property="invoiceTelNum" jdbcType="VARCHAR"/>
        <result column="invoice_title" property="invoiceTitle" jdbcType="VARCHAR"/>
        <result column="tax_register_num" property="taxRegisterNum" jdbcType="VARCHAR"/>
        <result column="tax_register_address" property="taxRegisterAddress" jdbcType="VARCHAR"/>
        <result column="tax_register_tel" property="taxRegisterTel" jdbcType="VARCHAR"/>
        <result column="tax_register_bank" property="taxRegisterBank" jdbcType="VARCHAR"/>
        <result column="tax_register_bank_account" property="taxRegisterBankAccount" jdbcType="VARCHAR"/>
        <result column="invoice_method_code" property="invoiceMethodCode" jdbcType="VARCHAR"/>
        <result column="invoice_type_code" property="invoiceTypeCode" jdbcType="VARCHAR"/>
        <result column="invoice_title_type_code" property="invoiceTitleTypeCode" jdbcType="VARCHAR"/>
        <result column="invoice_detail_type_code" property="invoiceDetailTypeCode" jdbcType="VARCHAR"/>
        <result column="execution_status_code" property="executionStatusCode" jdbcType="VARCHAR"/>
        <result column="executed_date" property="executedDate" jdbcType="DATE"/>
        <result column="executed_by" property="executedBy" jdbcType="DECIMAL"/>
        <result column="execution_bill_id" property="executionBillId" jdbcType="DECIMAL"/>
        <result column="execution_bill_num" property="executionBillNum" jdbcType="VARCHAR"/>
        <result column="execution_bill_data" property="executionBillData" jdbcType="VARCHAR"/>
        <result column="approved_date" property="approvedDate" jdbcType="DATE"/>
        <result column="approved_by" property="approvedBy" jdbcType="DECIMAL"/>
        <result column="approved_remark" property="approvedRemark" jdbcType="VARCHAR"/>
        <result column="close_status_code" property="closeStatusCode" jdbcType="VARCHAR"/>
        <result column="cancel_status_code" property="cancelStatusCode" jdbcType="VARCHAR"/>
        <result column="mall_order_num" property="mallOrderNum" jdbcType="VARCHAR"/>
        <result column="ec_preorder_num" property="ecPreorderNum" jdbcType="VARCHAR"/>
        <result column="ec_error_flag" property="ecErrorFlag" jdbcType="DECIMAL"/>
        <result column="ec_check_response_msg" property="ecCheckResponseMsg" jdbcType="VARCHAR"/>
        <result column="attachment_uuid" property="attachmentUuid" jdbcType="VARCHAR"/>
        <result column="sync_status" property="syncStatus" jdbcType="VARCHAR"/>
        <result column="sync_by" property="syncBy" jdbcType="DECIMAL"/>
        <result column="sync_date" property="syncDate" jdbcType="DATE"/>
        <result column="sync_remark" property="syncRemark" jdbcType="VARCHAR"/>
        <result column="sync_response_msg" property="syncResponseMsg" jdbcType="VARCHAR"/>
        <result column="remark" property="remark" jdbcType="VARCHAR"/>
        <result column="object_version_number" property="objectVersionNumber" jdbcType="DECIMAL"/>
        <result column="creation_date" property="creationDate" jdbcType="DATE"/>
        <result column="created_by" property="createdBy" jdbcType="DECIMAL"/>
        <result column="last_updated_by" property="lastUpdatedBy" jdbcType="DECIMAL"/>
        <result column="last_update_date" property="lastUpdateDate" jdbcType="DATE"/>
        <result column="unit_name" property="unitName" jdbcType="VARCHAR"/>
        <result column="platform_code" property="platformCode" jdbcType="VARCHAR"/>
        <result column="invoice_method_name" property="invoiceMethodName" jdbcType="VARCHAR"/>
        <result column="invoice_type_name" property="invoiceTypeName" jdbcType="VARCHAR"/>
        <result column="invoice_title_type_name" property="invoiceTitleTypeName" jdbcType="VARCHAR"/>
        <result column="urgent_flag" property="urgentFlag" jdbcType="DECIMAL"/>
        <result column="urgent_date" property="urgentDate" jdbcType="DATE"/>
        <result column="evaluate_flag" property="evaluateFlag" jdbcType="DECIMAL"/>
        <result column="satisfaction_degree_code" property="satisfactionDegreeCode" jdbcType="DECIMAL"/>
        <result column="evaluate_remark" property="evaluateRemark" jdbcType="VARCHAR"/>
        <result column="evaluate_by" property="evaluateBy" jdbcType="DECIMAL"/>
        <result column="evaluate_date" property="evaluateDate" jdbcType="DATE"/>
    </resultMap>

    <resultMap id="PrHeaderAndLineMap" type="org.srm.purchasecooperation.pr.domain.entity.PrHeader">
        <result column="pr_header_id" property="prHeaderId" jdbcType="DECIMAL"/>
        <result column="tenant_id" property="tenantId" jdbcType="DECIMAL"/>
        <result column="pr_status_code" property="prStatusCode" jdbcType="VARCHAR"/>
        <result column="previous_pr_status_code" property="previousPrStatusCode" jdbcType="VARCHAR"/>
        <result column="pr_source_platform" property="prSourcePlatform" jdbcType="VARCHAR"/>
        <result column="close_status_code" property="closeStatusCode" jdbcType="VARCHAR"/>
        <result column="cancel_status_code" property="cancelStatusCode" jdbcType="VARCHAR"/>
        <result column="object_version_number" property="objectVersionNumber" jdbcType="DECIMAL"/>
        <result column="created_by" property="createdBy" jdbcType="DECIMAL"/>
        <result column="purchase_agent_id" property="purchaseAgentId" jdbcType="DECIMAL"/>
        <result column="company_id" property="companyId" jdbcType="DECIMAL"/>
        <result column="pr_num" property="prNum" jdbcType="VARCHAR"/>
        <result column="external_num" property="externalNum" jdbcType="VARCHAR"/>
        <result column="creation_date" property="creationDate"/>
        <collection property="prLineList" ofType="org.srm.purchasecooperation.pr.domain.entity.PrLine"
                    javaType="java.util.ArrayList">
            <result column="pr_header_id" property="prHeaderId" jdbcType="DECIMAL"/>
            <result column="pr_line_id" property="prLineId" jdbcType="DECIMAL"/>
            <result column="tenant_id" property="tenantId" jdbcType="DECIMAL"/>
            <result column="execution_status_code" property="executionStatusCode" jdbcType="VARCHAR"/>
            <result column="execution_bill_id" property="executionBillId" jdbcType="DECIMAL"/>
        </collection>
    </resultMap>

    <sql id="Base_Column_List">
        sph.pr_header_id,
        sph.tenant_id,
        sph.pr_num,
        sph.display_pr_num,
        sph.pr_status_code,
        sph.previous_pr_status_code,
        sph.title,
        sph.request_date,
        sph.amount,
        sph.requested_by,
        sph.pr_requested_name,
        sph.contact_tel_num,
        sph.company_id,
        sph.ou_id,
        sph.purchase_org_id,
        sph.purchase_unit_name,
        sph.purchase_agent_id,
        sph.pr_source_platform,
        sph.lot_num,
        sph.receiver_address_id,
        sph.receiver_region_id,
        sph.receiver_contact_name,
        sph.receiver_tel_num,
        sph.receiver_address AS receiver_address_name,
        sph.invoice_address_id,
        sph.invoice_region_id,
        sph.invoice_contact_name,
        sph.invoice_tel_num,
        sph.invoice_title,
        sph.invoice_address AS invoice_address_name,
        sph.tax_register_num,
        sph.tax_register_address,
        sph.tax_register_tel,
        sph.tax_register_bank,
        sph.tax_register_bank_account,
        sph.invoice_method_code,
        sph.invoice_type_code,
        sph.invoice_title_type_code,
        sph.invoice_detail_type_code,
        sph.close_status_code,
        sph.cancel_status_code,
        sph.ec_error_flag,
        sph.ec_check_response_msg,
        sph.attachment_uuid,
        sph.remark,
        sph.object_version_number,
        sph.creation_date,
        sph.created_by,
        sph.last_updated_by,
        sph.last_update_date,
        sph.execution_status_code,
        sph.executed_date,
        sph.executed_by,
        sph.execution_bill_id,
        sph.execution_bill_num,
        sph.mall_order_num,
        sph.mall_pr_num,
        sph.sync_status,
        sph.sync_by,
        sph.sync_date,
        sph.sync_remark,
        <if test="_databaseId == 'oracle'">
            TO_CHAR(sph.sync_response_msg) AS sync_response_msg,
        </if>
        <if test="_databaseId == 'mysql' or _databaseId == 'sqlserver'">
            sph.sync_response_msg,
        </if>
        sph.freight,
        sph.ec_preorder_num,
        sph.receiver_email_address,
        sph.payment_method_code,
        sph.payment_method_name,
        sph.unit_id,
        sph.unit_name,
        sph.platform_code,
        sph.invoice_method_name,
        sph.invoice_type_name,
        sph.invoice_title_type_name,
        sph.invoice_detail_type_name,
        sph.urgent_flag,
        sph.urgent_date,
        sph.changed_flag,
        sph.tech_guidance_flag,
        sph.new_mall_flag,
        sph.original_currency
    </sql>

    <select id="selectPrHeaderDetail" resultType="org.srm.purchasecooperation.pr.domain.vo.PrHeaderVO">
        <bind name="lang" value="@io.choerodon.mybatis.helper.LanguageHelper@language()"/>
        SELECT
        <include refid="Base_Column_List"/>
        ,
        scbl.company_name,
        hou.ou_name,
        hou.ou_code,
        hpo.organization_name AS purchase_org_name,
        hpa.purchase_agent_name,
        sph.pr_type_id,
        sph.parent_unit_id,
        sph.category_id,
        sict.category_name,
        sph.accepter_user_id,
        sph.tech_guidance_flag,
        sph.tech_director_user_id,
        sph.inventory_id,
        sptl.pr_type_name,
        spt.pr_type_code,
        hu.unit_name as parent_unit_name,
        sph.invoice_company_id,
        iua.real_name as accepter_user_name,
        iut.real_name as tech_director_user_name,
        hi.inventory_name,
        sph.expense_unit_id,
        sph.expense_unit_name,
        scu.currency_id,
        scu.currency_code,
        scu.currency_name,
        iur.login_name as pr_requested_num,
        iuz.real_name as create_by_name,
        hpa.purchase_agent_code,
        iuz.login_name as submit_by,
        sph.attribute_varchar40,
        sph.attribute_varchar38,
        sph.attribute_varchar39,
        sph.attribute_varchar17,
        (CASE WHEN sph.pr_source_platform = 'SRM' THEN scu2.financial_precision ELSE NULL END) AS financial_precision,
        (CASE WHEN sph.pr_source_platform = 'SRM' THEN scu2.default_precision ELSE NULL END) AS default_precision
        FROM sprm_pr_header sph
        LEFT JOIN hpfm_company hc ON sph.company_id = hc.company_id
        LEFT JOIN (SELECT MAX(version_number) version_number,company_id FROM spfm_company_basic WHERE process_status = 'COMPLETE' GROUP BY company_id) scba_max
        on scba_max.company_id=hc.source_key
        LEFT JOIN spfm_company_basic scb ON scb.company_id = scba_max.company_id AND scba_max.version_number = scb.version_number
        LEFT JOIN spfm_company_basic_tl scbl ON scb.company_basic_id = scbl.company_basic_id
        AND scbl.lang = #{lang}
        LEFT JOIN hpfm_operation_unit hou ON sph.ou_id = hou.ou_id
        LEFT JOIN hpfm_purchase_organization hpo ON sph.purchase_org_id = hpo.purchase_org_id
        LEFT JOIN hpfm_purchase_agent hpa ON sph.purchase_agent_id = hpa.purchase_agent_id
        LEFT JOIN smdm_item_category sic ON sph.category_id = sic.category_id
        LEFT JOIN smdm_item_category_tl sict ON sict.category_id = sic.category_id AND sict.lang = #{lang}
        LEFT JOIN sprm_pr_type spt ON sph.pr_type_id = spt.pr_type_id
        LEFT JOIN sprm_pr_type_tl sptl ON sptl.pr_type_id = spt.pr_type_id AND sptl.lang = #{lang}
        LEFT JOIN hpfm_unit hu ON sph.parent_unit_id = hu.unit_id
        LEFT JOIN hpfm_unit hus ON sph.unit_id = hus.unit_id
        LEFT JOIN iam_user iua ON sph.accepter_user_id = iua.id
        LEFT JOIN iam_user iut ON sph.tech_director_user_id = iut.id
        LEFT JOIN hpfm_inventory hi ON hi.inventory_id = sph.inventory_id
        LEFT JOIN iam_user iuz ON iuz.id = sph.created_by
        LEFT JOIN iam_user iur ON iur.id = sph.requested_by
        LEFT JOIN smdm_currency scu ON scb.currency_id=scu.currency_id
        LEFT JOIN smdm_currency scu2 ON sph.original_currency = scu2.currency_code AND sph.tenant_id = scu2.tenant_id AND scu2.enabled_flag = 1
        WHERE sph.tenant_id = #{tenantId,jdbcType=BIGINT}
        AND sph.pr_header_id = #{prHeaderId,jdbcType=BIGINT}
        ORDER BY scb.creation_date DESC
    </select>

    <select id="selectPrSummaries" parameterType="org.srm.purchasecooperation.pr.api.dto.PrHeaderDTO"
            resultType="org.srm.purchasecooperation.pr.domain.vo.PrHeaderVO">
        <bind name="lang" value="@io.choerodon.mybatis.helper.LanguageHelper@language()"/>
        SELECT distinct
        <include refid="Base_Column_List"/>
        ,
        scbl.company_name,
        hou.ou_name,
        hpo.organization_name AS purchase_org_name,
        sph.pr_type_id,
        spt.pr_type_code,
        sptl.pr_type_name,
        sph.parent_unit_id,
        hu.unit_name as parent_unit_name,
        sph.invoice_company_id,
        spch.pc_num,
        iua.real_name as accepter_user_name,
        iut.real_name as tech_director_user_name,
        hi.inventory_name,
        sph.expense_unit_id,
        sph.expense_unit_name,
        hpa.purchase_agent_name,
        sph.evaluate_flag,
        sph.satisfaction_degree_code,
        sph.evaluate_remark,
        sph.evaluate_by,
        sph.evaluate_date,
        iur.login_name as pr_requested_num,
        iuz.real_name as create_by_name
        FROM sprm_pr_header sph
        LEFT JOIN hpfm_company hc ON sph.company_id = hc.company_id
        LEFT JOIN (SELECT MAX(version_number) version_number,company_id FROM spfm_company_basic WHERE process_status = 'COMPLETE' GROUP BY company_id) scba_max
        on scba_max.company_id=hc.source_key
        LEFT JOIN spfm_company_basic scb ON scb.company_id = scba_max.company_id AND scba_max.version_number = scb.version_number
        LEFT JOIN spfm_company_basic_tl scbl ON scb.company_basic_id = scbl.company_basic_id
        AND scbl.lang = #{lang}
        LEFT JOIN hpfm_operation_unit hou ON sph.ou_id = hou.ou_id
        LEFT JOIN hpfm_purchase_organization hpo ON sph.purchase_org_id = hpo.purchase_org_id
        LEFT JOIN hpfm_purchase_agent hpa ON sph.purchase_agent_id = hpa.purchase_agent_id
        LEFT JOIN hpfm_unit hu ON sph.parent_unit_id = hu.unit_id
        LEFT JOIN sprm_pr_type spt ON sph.pr_type_id = spt.pr_type_id
        LEFT JOIN sprm_pr_type_tl sptl ON sptl.pr_type_id = spt.pr_type_id AND sptl.lang = #{lang}
        LEFT JOIN sprm_pr_line sprl ON (sph.pr_header_id = sprl.pr_header_id and sph.tenant_id = sprl.tenant_id)
        LEFT JOIN spcm_pc_header spch ON sprl.pc_header_id = spch.pc_header_id
        LEFT JOIN iam_user iua ON iua.id = sph.accepter_user_id
        LEFT JOIN iam_user iut ON iut.id = sph.tech_director_user_id
        LEFT JOIN iam_user iuz ON iuz.id = sph.created_by
        LEFT JOIN iam_user iur ON iur.id = sph.requested_by
        LEFT JOIN hpfm_inventory hi ON hi.inventory_id = sph.inventory_id

        WHERE 1 = 1
        <choose>
            <when test="prStatusCode != null and prStatusCode != ''">
                AND sph.pr_status_code = #{prStatusCode}
            </when>
            <otherwise>
                <if test="prStatusCodeList != null and prStatusCodeList.size() gt 0">
                    AND sph.pr_status_code IN
                    <foreach collection="prStatusCodeList" item="statusCode" open="(" close=")" separator=",">
                        #{statusCode}
                    </foreach>
                </if>
            </otherwise>
        </choose>
        <if test="companyId != null">
            AND sph.company_id = #{companyId}
        </if>
        <if test="purchaseOrgId != null">
            AND sph.purchase_org_id = #{purchaseOrgId}
        </if>
        <if test="tenantId != null">
            AND sph.tenant_id = #{tenantId}
        </if>
        <if test="displayPrNum != null and displayPrNum != ''">
            <bind name="displayPrNumLike" value="'%'+displayPrNum +'%'"/>
            AND(sph.display_pr_num LIKE #{displayPrNumLike}
            OR sph.pr_num LIKE #{displayPrNumLike})
        </if>
        <if test="displayPrNumList != null and displayPrNumList.size() > 0">
            AND sph.display_pr_num IN
            <foreach collection="displayPrNumList" item="displayPr" open="(" close=")" separator=",">
                #{displayPr}
            </foreach>
        </if>
        <if test="requestDateStart != null">
            AND sph.request_date &gt;= #{requestDateStart}
        </if>
        <if test="requestDateEnd != null">
            AND sph.request_date &lt;= #{requestDateEnd}
        </if>
        <if test="urgentFlag != null">
            AND sph.urgent_flag = #{urgentFlag}
        </if>
        <if test="prRequestedName != null and prRequestedName != ''">
            <bind name="prRequestedNameLike" value="'%'+prRequestedName +'%'"/>
            AND sph.pr_requested_name LIKE #{prRequestedNameLike}
        </if>
        <if test="purchaseAgentId != null">
            AND sph.purchase_agent_id = #{purchaseAgentId}
        </if>
        <if test="purchaseAgentName != null and purchaseAgentName != ''">
            <bind name="purchaseAgentNameLike" value="'%'+purchaseAgentName +'%'"/>
            AND hpa.purchase_agent_name LIKE #{purchaseAgentNameLike}
        </if>
        <if test="prSourcePlatform != null and prSourcePlatform != ''">
            AND sph.pr_source_platform = #{prSourcePlatform}
        </if>
        <if test="closeStatusCode != null and closeStatusCode != ''">
            AND sph.close_status_code = #{closeStatusCode}
        </if>
        <choose>
            <when test="cancelStatusCode != null and cancelStatusCode != ''">
                AND sph.cancel_status_code = #{cancelStatusCode}
            </when>
            <otherwise>
                <if test="prCancelStatusList != null and prCancelStatusList.size() gt 0">
                    AND sph.cancel_status_code IN
                    <foreach collection="prCancelStatusList" item="statusCode" open="(" close=")" separator=",">
                        #{statusCode}
                    </foreach>
                </if>
            </otherwise>
        </choose>
        <if test="creationDateFrom !=null">
            AND sph.creation_date >= #{creationDateFrom}
        </if>
        <if test="creationDateTo !=null">
            AND sph.creation_date &lt; #{creationDateTo}
        </if>
        <if test="lotNum != null">
            AND sph.lot_num = #{lotNum}
        </if>
        <if test="unitId != null">
            AND sph.unit_id = #{unitId}
        </if>
        <if test="title != null and title != ''">
            <bind name="titleLike" value="'%'+title+'%'"/>
            AND sph.title LIKE #{titleLike}
        </if>
        AND sph.pr_status_code !=  'WORKFLOW_APPROVAL'
        AND sph.external_approving_flag != 1
    </select>

    <select id="selectPrSummariesAndWorkFlow" parameterType="org.srm.purchasecooperation.pr.api.dto.PrHeaderDTO"
            resultType="org.srm.purchasecooperation.pr.domain.vo.PrHeaderVO">
        <bind name="lang" value="@io.choerodon.mybatis.helper.LanguageHelper@language()"/>
        SELECT distinct
        <include refid="Base_Column_List"/>
        ,
        scbl.company_name,
        hou.ou_name,
        hpo.organization_name AS purchase_org_name,
        sph.pr_type_id,
        spt.pr_type_code,
        sptl.pr_type_name,
        sph.parent_unit_id,
        hu.unit_name as parent_unit_name,
        sph.invoice_company_id,
        iscbl.company_name as invoice_company_name,
        spch.pc_num,
        iua.real_name as accepter_user_name,
        iut.real_name as tech_director_user_name,
        hi.inventory_name,
        sph.expense_unit_id,
        sph.expense_unit_name,
        hpa.purchase_agent_name,
        sph.evaluate_flag,
        sph.satisfaction_degree_code,
        sph.evaluate_remark,
        sph.evaluate_by,
        sph.evaluate_date,
        iur.login_name as pr_requested_num,
        iuz.real_name as create_by_name,
        (CASE WHEN sph.pr_source_platform = 'SRM' THEN scu.financial_precision ELSE NULL END) AS financial_precision,
        (CASE WHEN sph.pr_source_platform = 'SRM' THEN scu.default_precision ELSE NULL END) AS default_precision
        FROM sprm_pr_header sph
        LEFT JOIN hpfm_company hc ON sph.company_id = hc.company_id
        LEFT JOIN (SELECT MAX(version_number) version_number,company_id FROM spfm_company_basic WHERE process_status = 'COMPLETE' GROUP BY company_id) scba_max
        on scba_max.company_id=hc.source_key
        LEFT JOIN spfm_company_basic scb ON scb.company_id = scba_max.company_id AND scba_max.version_number = scb.version_number
        LEFT JOIN spfm_company_basic_tl scbl ON scb.company_basic_id = scbl.company_basic_id
        AND scbl.lang = #{lang}
        LEFT JOIN hpfm_company ihc ON sph.invoice_company_id = ihc.company_id
        LEFT JOIN (SELECT MAX(version_number) version_number,company_id FROM spfm_company_basic WHERE process_status = 'COMPLETE' GROUP BY company_id) iscba_max
        on iscba_max.company_id=ihc.source_key
        LEFT JOIN spfm_company_basic iscb ON iscb.company_id = iscba_max.company_id AND iscba_max.version_number = iscb.version_number
        LEFT JOIN spfm_company_basic_tl iscbl ON iscb.company_basic_id = iscbl.company_basic_id
        AND iscbl.lang = #{lang}
        LEFT JOIN hpfm_operation_unit hou ON sph.ou_id = hou.ou_id
        LEFT JOIN hpfm_purchase_organization hpo ON sph.purchase_org_id = hpo.purchase_org_id
        LEFT JOIN hpfm_purchase_agent hpa ON sph.purchase_agent_id = hpa.purchase_agent_id
        LEFT JOIN hpfm_unit hu ON sph.parent_unit_id = hu.unit_id
        LEFT JOIN sprm_pr_type spt ON sph.pr_type_id = spt.pr_type_id
        LEFT JOIN sprm_pr_type_tl sptl ON sptl.pr_type_id = spt.pr_type_id AND sptl.lang = #{lang}
        LEFT JOIN sprm_pr_line sprl ON (sph.pr_header_id = sprl.pr_header_id and sph.tenant_id = sprl.tenant_id)
        LEFT JOIN spcm_pc_header spch ON sprl.pc_header_id = spch.pc_header_id
        LEFT JOIN iam_user iua ON iua.id = sph.accepter_user_id
        LEFT JOIN iam_user iut ON iut.id = sph.tech_director_user_id
        LEFT JOIN iam_user iuz ON iuz.id = sph.created_by
        LEFT JOIN iam_user iur ON iur.id = sph.requested_by
        LEFT JOIN hpfm_inventory hi ON hi.inventory_id = sph.inventory_id
        LEFT JOIN smdm_currency scu ON sph.original_currency = scu.currency_code AND sph.tenant_id = scu.tenant_id AND scu.enabled_flag = 1
        WHERE 1 = 1
        <if test="purchasePlatformQueryParam1 != null and purchasePlatformQueryParam1 != ''">
            <bind name="purchasePlatformQueryParam1Like" value="'%'+purchasePlatformQueryParam1 +'%'"/>
            AND (sph.display_pr_num LIKE #{purchasePlatformQueryParam1Like}
            OR sph.title LIKE #{purchasePlatformQueryParam1Like}
            OR iuz.real_name LIKE #{purchasePlatformQueryParam1Like})
        </if>
        <choose>
            <when test="prStatusCode != null and prStatusCode != ''">
                AND sph.pr_status_code = #{prStatusCode}
            </when>
            <otherwise>
                <if test="prStatusCodeList != null and prStatusCodeList.size() gt 0">
                    AND sph.pr_status_code IN
                    <foreach collection="prStatusCodeList" item="statusCode" open="(" close=")" separator=",">
                        #{statusCode}
                    </foreach>
                </if>
            </otherwise>
        </choose>
        <if test="tenantId != null">
            AND sph.tenant_id = #{tenantId}
        </if>
        <if test="prTypeId != null">
            AND sph.pr_type_id = #{prTypeId}
        </if>
        <if test="companyId != null">
            AND sph.company_id = #{companyId}
        </if>
        <if test="purchaseOrgId != null">
            AND sph.purchase_org_id = #{purchaseOrgId}
        </if>
        <if test="displayPrNum != null and displayPrNum != ''">
            <bind name="displayPrNumLike" value="'%'+displayPrNum +'%'"/>
            AND(sph.display_pr_num LIKE #{displayPrNumLike}
            OR sph.pr_num LIKE #{displayPrNumLike})
        </if>
        <if test="displayPrNumList != null and displayPrNumList.size() > 0">
            AND sph.display_pr_num IN
            <foreach collection="displayPrNumList" item="displayPr" open="(" close=")" separator=",">
                #{displayPr}
            </foreach>
        </if>
        <if test="requestDateStart != null">
            AND sph.request_date &gt;= #{requestDateStart}
        </if>
        <if test="requestDateEnd != null">
            AND sph.request_date &lt;= #{requestDateEnd}
        </if>
        <if test="urgentFlag != null">
            AND sph.urgent_flag = #{urgentFlag}
        </if>
        <if test="prRequestedName != null and prRequestedName != ''">
            <bind name="prRequestedNameLike" value="'%'+prRequestedName +'%'"/>
            AND sph.pr_requested_name LIKE #{prRequestedNameLike}
        </if>
        <if test="purchaseAgentId != null">
            AND sph.purchase_agent_id = #{purchaseAgentId}
        </if>
        <if test="purchaseAgentName != null and purchaseAgentName != ''">
            <bind name="purchaseAgentNameLike" value="'%'+purchaseAgentName +'%'"/>
            AND hpa.purchase_agent_name LIKE #{purchaseAgentNameLike}
        </if>
        <if test="prSourcePlatform != null and prSourcePlatform != ''">
            AND sph.pr_source_platform = #{prSourcePlatform}
        </if>
        <if test="closeStatusCode != null and closeStatusCode != ''">
            AND sph.close_status_code = #{closeStatusCode}
        </if>
        <choose>
            <when test="cancelStatusCode != null and cancelStatusCode != ''">
                AND sph.cancel_status_code = #{cancelStatusCode}
            </when>
            <otherwise>
                <if test="prCancelStatusList != null and prCancelStatusList.size() gt 0">
                    AND sph.cancel_status_code IN
                    <foreach collection="prCancelStatusList" item="statusCode" open="(" close=")" separator=",">
                        #{statusCode}
                    </foreach>
                </if>
            </otherwise>
        </choose>
        <if test="creationDateFrom !=null">
            AND sph.creation_date >= #{creationDateFrom}
        </if>
        <if test="creationDateTo !=null">
            AND sph.creation_date &lt; #{creationDateTo}
        </if>
        <if test="lotNum != null">
            AND sph.lot_num = #{lotNum}
        </if>
        <if test="unitId != null">
            AND sph.unit_id = #{unitId}
        </if>
        <if test="title != null and title != ''">
            <bind name="titleLike" value="'%'+title+'%'"/>
            AND sph.title LIKE #{titleLike}
        </if>
        <if test="invoiceCompanyId != null">
            AND sph.invoice_company_id = #{invoiceCompanyId}
        </if>
        <if test="creatorName != null and creatorName != ''">
            <bind name="creatorNameLike" value="'%'+creatorName+'%'"/>
            AND iuz.real_name like #{creatorNameLike}
        </if>
    </select>

    <select id="selectCancellablePr" parameterType="org.srm.purchasecooperation.pr.api.dto.PrHeaderDTO"
            resultType="org.srm.purchasecooperation.pr.domain.vo.PrHeaderVO">
        <bind name="lang" value="@io.choerodon.mybatis.helper.LanguageHelper@language()"/>
        SELECT
        <include refid="Base_Column_List"/>
        ,
        scbl.company_name,
        hou.ou_name,
        hpo.organization_name AS purchase_org_name,
        hpa.purchase_agent_name,
        iuz.real_name as create_by_name
        FROM sprm_pr_header sph
        LEFT JOIN hpfm_company hc ON sph.company_id = hc.company_id
        LEFT JOIN (SELECT MAX(version_number) version_number,company_id FROM spfm_company_basic WHERE process_status = 'COMPLETE' GROUP BY company_id) scba_max
        on scba_max.company_id=hc.source_key
        LEFT JOIN spfm_company_basic scb ON scb.company_id = scba_max.company_id AND scba_max.version_number = scb.version_number
        LEFT JOIN spfm_company_basic_tl scbl ON scb.company_basic_id = scbl.company_basic_id
        AND scbl.lang = #{lang}
        LEFT JOIN hpfm_operation_unit hou ON sph.ou_id = hou.ou_id
        LEFT JOIN hpfm_purchase_organization hpo ON sph.purchase_org_id = hpo.purchase_org_id
        LEFT JOIN hpfm_purchase_agent hpa ON sph.purchase_agent_id = hpa.purchase_agent_id
        LEFT JOIN iam_user iuz ON iuz.id = sph.created_by
        WHERE 1 = 1
        AND (
        CASE
        WHEN sph.pr_status_code = 'REJECTED' AND sph.changed_flag = 1 THEN 1
        WHEN sph.pr_status_code = 'APPROVED' THEN 1
        WHEN sph.pr_status_code = 'CHANGE' THEN 1
        ELSE 0
        END
        ) = 1
        <if test="tenantId != null">
            AND sph.tenant_id = #{tenantId}
        </if>
        <if test="displayPrNum != null and displayPrNum != ''">
            <bind name="displayPrNumLike" value="'%'+displayPrNum +'%'"/>
            AND sph.display_pr_num LIKE #{displayPrNumLike}
        </if>
        <if test="requestDateStart != null">
            AND sph.request_date &gt;= #{requestDateStart}
        </if>
        <if test="requestDateEnd != null">
            AND sph.request_date &lt;= #{requestDateEnd}
        </if>
        <if test="prRequestedName != null and prRequestedName != ''">
            <bind name="prRequestedNameLike" value="'%'+prRequestedName +'%'"/>
            AND sph.pr_requested_name LIKE #{prRequestedNameLike}
        </if>
        <if test="purchaseAgentId != null">
            AND sph.purchase_agent_id = #{purchaseAgentId}
        </if>
        <if test="purchaseAgentName != null and purchaseAgentName != ''">
            <bind name="purchaseAgentNameLike" value="'%'+purchaseAgentName +'%'"/>
            AND hpa.purchase_agent_name LIKE #{purchaseAgentNameLike}
        </if>
        <if test="prSourcePlatform != null and prSourcePlatform != ''">
            AND sph.pr_source_platform = #{prSourcePlatform}
        </if>
        <if test="closeStatusCode != null and closeStatusCode != ''">
            AND sph.close_status_code = #{closeStatusCode}
        </if>
        <choose>
            <when test="cancelStatusCode != null and cancelStatusCode != ''">
                AND sph.cancel_status_code = #{cancelStatusCode}
            </when>
            <otherwise>
                <if test="prCancelStatusList != null and prCancelStatusList.size() gt 0">
                    AND sph.cancel_status_code IN
                    <foreach collection="prCancelStatusList" item="statusCode" open="(" close=")" separator=",">
                        #{statusCode}
                    </foreach>
                </if>
            </otherwise>
        </choose>
        <if test="creationDateFrom !=null">
            AND sph.creation_date >= #{creationDateFrom}
        </if>
        <if test="creationDateTo !=null">
            AND sph.creation_date &lt; #{creationDateTo}
        </if>
        <if test="lotNum != null">
            AND sph.lot_num = #{lotNum}
        </if>
        <if test="unitId != null">
            AND sph.unit_id = #{unitId}
        </if>
        <if test="title != null and title != ''">
            <bind name="titleLike" value="'%'+title+'%'"/>
            AND sph.title LIKE #{titleLike}
        </if>
        <!-- todo 保证数据正确的情况的下，可删除过这个过滤条件，目前订单更新头行的取消关闭状态时未更新头的取消状态 -->
        <!--AND-->
        <!--&lt;!&ndash; 不存在不可取消的行 &ndash;&gt;-->
        <!--NOT EXISTS(-->
        <!--SELECT 1-->
        <!--FROM sprm_pr_line spl-->
        <!--WHERE spl.pr_header_id = sph.pr_header_id-->
        <!--AND (-->
        <!--spl.cancelled_flag = 1-->
        <!--OR spl.closed_flag = 1-->
        <!--OR spl.assigned_flag = 1-->
        <!--OR spl.execution_status_code IS NOT NULL-->
        <!--)-->
        <!--)-->
    </select>

    <select id="selectHeaderAndLine" resultMap="PrHeaderAndLineMap">
        select
        sph.pr_header_id,
        sph.pr_status_code,
        sph.previous_pr_status_code,
        sph.pr_source_platform,
        sph.close_status_code,
        sph.cancel_status_code,
        sph.object_version_number,
        sph.created_by,
        sph.purchase_agent_id,
        sph.company_id,
        sph.pr_num,
        sph.tenant_id,
        sph.external_num,
        spl.pr_line_id,
        spl.execution_status_code,
        spl.execution_bill_id,
        sph.creation_date
        from
        sprm_pr_header sph
        join sprm_pr_line spl on sph.pr_header_id = spl.pr_header_id
        and sph.tenant_id = spl.tenant_id
        where 1 = 1
        and sph.tenant_id = #{tenantId}
        and sph.pr_num in
        <foreach collection="prNums" index="index" item="prNum" open="(" separator="," close=")">
            #{prNum}
        </foreach>
    </select>
    <select id="selectPrHeaderExport" parameterType="org.srm.purchasecooperation.pr.api.dto.PrHeaderExportDTO"
            resultType="org.srm.purchasecooperation.pr.domain.vo.PrHeaderExportVO">
        <bind name="lang" value="@io.choerodon.mybatis.helper.LanguageHelper@language()"/>
        SELECT sph.pr_header_id,
        sph.pr_status_code,
        sph.display_pr_num,
        sph.title,
        sph.urgent_flag,
        sph.request_date,
        sptl.pr_type_name,
        sph.pr_requested_name,
        sph.creation_date,
        sph.pr_source_platform,
        sph.remark,
        sph.cancel_status_code,
        sph.close_status_code,
        sph.unit_name,
        scbl.company_name,
        hpo.organization_name AS purchase_org_name,
        hpa.purchase_agent_name,
        sph.amount
        FROM sprm_pr_header sph
        LEFT JOIN sprm_pr_type spt ON spt.pr_type_id = sph.pr_type_id
        LEFT JOIN sprm_pr_type_tl sptl ON sptl.pr_type_id = spt.pr_type_id AND sptl.lang = #{lang}
        LEFT JOIN hpfm_company hc ON sph.company_id = hc.company_id
        LEFT JOIN (SELECT MAX(version_number) version_number,company_id FROM spfm_company_basic WHERE process_status = 'COMPLETE' GROUP BY company_id) scba_max
        on scba_max.company_id=hc.source_key
        LEFT JOIN spfm_company_basic scb ON scb.company_id = scba_max.company_id AND scba_max.version_number = scb.version_number
        LEFT JOIN spfm_company_basic_tl scbl ON scb.company_basic_id = scbl.company_basic_id
        AND scbl.lang = #{lang}
        LEFT JOIN hpfm_operation_unit hou ON sph.ou_id = hou.ou_id
        LEFT JOIN hpfm_purchase_organization hpo ON sph.purchase_org_id = hpo.purchase_org_id
        LEFT JOIN hpfm_purchase_agent hpa ON sph.purchase_agent_id = hpa.purchase_agent_id
        WHERE sph.tenant_id = ${tenantId}
        <choose>
            <when test="prHeaderIds != null and prHeaderIds.size gt 0">
                AND sph.pr_header_id IN
                <foreach collection="prHeaderIds" index="index" item="prHeaderId" open="(" separator="," close=")">
                    #{prHeaderId}
                </foreach>
            </when>
            <otherwise>
                <if test="urgentFlag != null">
                    AND sph.urgent_flag = #{urgentFlag}
                </if>
                <if test="title != null and title != ''">
                    <bind name="titleLike" value="'%'+title+'%'"/>
                    AND sph.title LIKE #{titleLike}
                </if>
                <if test="displayPrNum != null and displayPrNum != ''">
                    <bind name="prNumLike" value="'%'+displayPrNum +'%'"/>
                    AND sph.display_pr_num LIKE #{prNumLike}
                </if>
                <if test="prRequestedName != null and prRequestedName != ''">
                    <bind name="prRequestedNameLike" value="'%'+prRequestedName +'%'"/>
                    AND sph.pr_requested_name LIKE #{prRequestedNameLike}
                </if>
                <if test="prStatusCode != null and prStatusCode != ''">
                    AND sph.pr_status_code = #{prStatusCode}
                </if>
                <if test="requestedBy != null">
                    AND sph.requested_by = #{requestedBy}
                </if>
                <if test="prSourcePlatform != null and prSourcePlatform != ''">
                    AND sph.pr_source_platform = #{prSourcePlatform}
                </if>
                <if test="closeStatusCode != null and closeStatusCode != ''">
                    AND sph.close_status_code = #{closeStatusCode}
                </if>
                <if test="cancelStatusCode != null and cancelStatusCode != ''">
                    AND sph.cancel_status_code = #{cancelStatusCode}
                </if>
                <if test="creationDateFrom != null">
                    AND sph.creation_date >= #{creationDateFrom}
                </if>
                <if test="creationDateTo != null">
                    AND sph.creation_date &lt; #{creationDateTo}
                </if>
                <if test="unitId != null">
                    AND sph.unit_id = #{unitId}
                </if>
                <if test="companyId != null">
                    AND sph.company_id = #{companyId}
                </if>
                <if test="purchaseOrgId != null">
                    AND sph.purchase_org_id = #{purchaseOrgId}
                </if>
                <if test="purchaseAgentId != null">
                    AND sph.purchase_agent_id = #{purchaseAgentId}
                </if>
            </otherwise>
        </choose>
    </select>

    <select id="selectCompanyInvoiceInfo" resultMap="BaseResultMap">
        SELECT
        hc.company_id,
        sci.invoice_header AS invoice_title,
        sci.tax_registration_number AS tax_register_num,
        sci.deposit_bank AS tax_register_bank,
        sci.bank_account_num AS tax_register_bank_account,
        sci.tax_registration_address AS tax_register_address,
        sci.tax_registration_phone AS tax_register_tel,
        sci.receive_mail AS receiver_email_address,
        sci.receive_phone AS invoice_tel_num
        FROM
        spfm_company_invoice sci
        JOIN hpfm_company hc ON hc.source_key = sci.company_id AND hc.source_code = 'SRM'
        WHERE
        hc.tenant_id = #{tenantId}
        AND hc.company_id IN
        <foreach collection="companyIds" index="index" item="companyId" open="(" separator="," close=")">
            #{companyId}
        </foreach>
    </select>
    <select id="listPrHeaderByPoLineId" resultMap="BaseResultMap">
        SELECT
        <include refid="Base_Column_List"/>
        FROM sprm_pr_header sph
        JOIN sodr_po_line_location loc ON loc.pr_header_id=sph.pr_header_id
        JOIN sodr_po_line pol ON loc.po_line_id=loc.po_line_id
        WHERE pol.po_line_id = #{poLineId}
    </select>

    <select id="selectByHeaderIdList" resultMap="BaseResultMap">
        SELECT
        <include refid="Base_Column_List"/>
        FROM sprm_pr_header sph
        WHERE sph.pr_header_id
        IN
        <foreach collection="prHeaderIdList" item="prHeaderId" index="index" open="(" close=")" separator=",">
            #{prHeaderId}
        </foreach>
    </select>

    <select id="selectPrHeaderForMall" parameterType="org.srm.purchasecooperation.pr.api.dto.PrHeaderDTO" resultMap="BaseResultMap">
        SELECT
        prh.pr_header_id,
        prh.company_id,
        prh.tenant_id,
        prh.creation_date,
        prh.display_pr_num,
        prh.freight,
        prh.amount,
        prh.ou_id,
        prh.receiver_address,
        prh.invoice_type_code,
        prh.pr_source_platform,
        prh.mall_order_num,
        prh.receiver_address_id,
        prh.purchase_org_id,
        ou.ou_name,
        po.organization_name as purchase_org_name
        FROM
        sprm_pr_header prh
        JOIN hpfm_operation_unit ou on ou.ou_id = prh.ou_id
        LEFT JOIN hpfm_purchase_organization po on po.purchase_org_id = prh.purchase_org_id
        WHERE
        1 = 1
        AND prh.pr_source_platform IN ('CATALOGUE')
        AND prh.tenant_id = #{tenantId}
        <if test="displayPrNum != null and displayPrNum != ''">
            <bind name="displayPrNumLike" value="'%' + displayPrNum +'%'"/>
            AND prh.display_pr_num LIKE #{displayPrNumLike}
        </if>
        <if test="prSourcePlatform != null and prSourcePlatform != ''">
            AND prh.pr_source_platform = #{prSourcePlatform}
        </if>
        <if test="requestedBy != null">
            AND prh.requested_by = #{requestedBy}
        </if>
        <if test="invoiceTypeCode != null and invoiceTypeCode != ''">
            AND prh.invoice_type_code = #{invoiceTypeCode}
        </if>
        <if test="creationDateFrom != null">
            AND prh.creation_date &gt;= #{creationDateFrom}
        </if>
        <if test="creationDateTo != null">
            AND prh.creation_date &lt; #{creationDateTo}
        </if>
        <if test="createdBy != null">
            AND prh.created_by = #{createdBy}
        </if>
        <if test="(supplierCompanyId != null) or (productName != null and productName != '')">
            AND EXISTS (
            SELECT
            1
            FROM
            sprm_pr_line prl
            WHERE prl.pr_header_id = prh.pr_header_id
            <if test="supplierCompanyId != null">
                AND prl.supplier_company_id = #{supplierCompanyId}
            </if>
            <if test="productName != null and productName != ''">
                <bind name="productNameLike" value="'%' + productName +'%'"/>
                AND prl.product_name LIKE #{productNameLike}
            </if>
            )
        </if>
        ORDER BY prh.creation_date DESC
    </select>
    <select id="selectEcCreateFailed" resultType="org.srm.purchasecooperation.pr.domain.entity.PrHeader">
        SELECT
        sph.pr_header_id
        FROM sprm_pr_header sph
        WHERE sph.tenant_id = #{tenantId}
        AND sph.pr_source_platform = 'E-COMMERCE'
        AND sph.mall_order_num IN
        <foreach collection="mallOrderNums" item="mallOrderNum"  open="(" close=")" separator=",">
            #{mallOrderNum}
        </foreach>
    </select>
    <select id="selectPrLineNotIn" resultType="java.lang.Long">
        SELECT
        sph.pr_header_id
        FROM
        sprm_pr_header sph
        JOIN sprm_pr_line spl ON sph.pr_header_id = spl.pr_header_id
        WHERE 1=1
        and sph.pr_header_id IN
        <foreach collection="headerIds" item="headerId"  open="(" close=")" separator=",">
            #{headerId}
        </foreach>
        and sph.close_status_code != 'CLOSED'
        and spl.closed_flag=0
    </select>
    <select id="selectPrHeaderByEs" resultType="org.srm.purchasecooperation.pr.domain.entity.PrHeader">
        SELECT
        <include refid="Base_Column_List"/>
        FROM
        sprm_pr_header_es sphe
        JOIN sprm_pr_header sph ON sph.pr_header_id = sphe.pr_header_id
        WHERE
        1 = 1
        <if test="externalSystemCode != null and externalSystemCode != ''">
            AND sphe.external_system_code = #{externalSystemCode}
        </if>
        <if test="esPrHeaderId != null and esPrHeaderId != ''">
            AND sphe.es_pr_header_id = #{esPrHeaderId}
        </if>
        <if test="esPrNumber != null and esPrNumber != ''">
            AND sphe.es_pr_number = #{esPrNumber}
        </if>
    </select>
    <select id="calcPrHeaderCancelStatus" resultType="java.lang.String">
        SELECT
        CASE
        WHEN
            splg.part_count = 0 THEN
        NULL
            WHEN spl.all_count = splg.part_count THEN
            'UNCANCELLED' ELSE 'CANCELLED_PARTIAL'
            END AS cancelled_status
        FROM
            ( SELECT count( splg.pr_line_id ) AS all_count FROM sprm_pr_line splg WHERE splg.pr_header_id = #{prHeaderId} ) spl,
            ( SELECT count( pr_line_id ) AS part_count FROM sprm_pr_line WHERE pr_header_id = #{prHeaderId} AND cancelled_flag = 0 ) splg;
    </select>
    <select id="selectPrHeaderEvaluateInfo" resultType="org.srm.purchasecooperation.pr.domain.vo.EvaluateInfoVO">
        SELECT
        sph.evaluate_by,
        sph.evaluate_date,
        sph.evaluate_remark,
        sph.satisfaction_degree_code,
        sph.evaluate_flag,
        sph.pr_header_id,
        sph.tenant_id
        FROM
        sprm_pr_header sph
        <where>
            <if test="tenantId!=null">
                and  sph.tenant_id=#{tenantId}
            </if>
            <if test="prHeaderId">
                and  sph.pr_header_id=#{prHeaderId}
            </if>
        </where>
    </select>
    <select id="selectUserIdsByPs" resultType="java.lang.Long">
        SELECT DISTINCT
            imr.member_id user_id
        FROM
            iam_role_permission irp
            JOIN iam_menu im ON irp.permission_id = im.id
            JOIN iam_role ir ON ir.id = irp.role_id
            JOIN iam_member_role imr ON imr.role_id = ir.id
            JOIN iam_user iu ON iu.id = imr.member_id
            JOIN hiam_user_authority hua ON hua.user_id = iu.id
            JOIN hiam_user_authority_line hual ON hua.authority_id = hual.authority_id
        WHERE
            im.CODE = #{psCode}
            AND ir.h_tenant_id = #{tenantId}
            and (irp.h_create_flag = 'Y' or irp.h_inherit_flag = 'Y')
            AND im.h_enabled_flag = 1
            AND ir.is_enabled = 1
            AND iu.is_enabled = 1
            AND iu.organization_id = ir.h_tenant_id
            AND hua.tenant_id = iu.organization_id
            AND hua.authority_type_code = 'OU'
            AND ( hua.include_all_flag = 1 OR hual.data_id = #{ouId} )
    </select>
    <select id="selectMainPurchaseAgentId" resultType="java.lang.Long">
        SELECT
            sicp.purchase_agent_id
        FROM
            smdm_item_category_pc sicp
        WHERE
         sicp.main_purchase_flag=1
         AND sicp.tenant_id=#{tenantId}
         AND sicp.category_id=#{categoryId}
    </select>

    <select id="itemOrgRel" resultType="integer">
        SELECT
             count(*)
        FROM
            smdm_item_org_rel hior
        WHERE
            hior.tenant_id = #{tenantId}
            AND hior.item_id = #{itemId}
            AND hior.organization_id = #{invOrganizationId}
    </select>
    <select id="selectCompanyByCompanyId" resultType="org.srm.purchasecooperation.pr.domain.vo.CompanyVO">
        <bind name="lang" value="@io.choerodon.mybatis.helper.LanguageHelper@language()"/>
        select hc.company_num,
        scbl.company_name,
        hc.registered_country_id
        from hpfm_company hc
        LEFT JOIN (SELECT MAX(version_number) version_number,company_id FROM spfm_company_basic WHERE process_status = 'COMPLETE' GROUP BY company_id) scba_max
        on scba_max.company_id=hc.source_key
        LEFT JOIN spfm_company_basic scb ON scb.company_id = scba_max.company_id AND scba_max.version_number = scb.version_number
        LEFT JOIN spfm_company_basic_tl scbl ON scb.company_basic_id = scbl.company_basic_id
        AND scbl.lang = #{lang}
        where hc.company_id=#{companyId}
    </select>

    <select id="selectUsersByPsAndAuTypeCode" resultType="org.srm.purchasecooperation.order.domain.entity.User">
        SELECT DISTINCT
            imr.member_id id,
            iu.email,
            iu.phone,
            iu.real_name
        FROM
            iam_role_permission irp
                JOIN iam_menu im ON irp.permission_id = im.id
                JOIN iam_role ir ON ir.id = irp.role_id
                JOIN iam_member_role imr ON imr.role_id = ir.id
                JOIN iam_user iu ON iu.id = imr.member_id
                JOIN hiam_user_authority hua ON hua.user_id = iu.id
                JOIN hiam_user_authority_line hual ON hua.authority_id = hual.authority_id
        WHERE
            im.CODE = #{psCode}
          AND ir.h_tenant_id = #{tenantId}
          and (irp.h_create_flag = 'Y' or irp.h_inherit_flag = 'Y')
          AND im.h_enabled_flag = 1
          AND ir.is_enabled = 1
          AND iu.is_enabled = 1
          AND iu.organization_id = ir.h_tenant_id
          AND hua.tenant_id = iu.organization_id
          AND hua.authority_type_code = #{authorityTypeCode}
          AND ( hua.include_all_flag = 1 OR hual.data_id = #{dataId} )
    </select>

    <select id="checkPrSupplierAllowOrder" resultType="java.lang.String">
        SELECT
            slcs.stage_description
        FROM sprm_pr_header sph
         JOIN sprm_pr_line spl ON sph.pr_header_id = spl.pr_header_id
         JOIN sslm_life_cycle slc ON slc.tenant_id = sph.tenant_id AND slc.company_id = sph.company_id AND slc.supplier_tenant_id = spl.supplier_tenant_id AND slc.supplier_company_id = spl.supplier_company_id
         JOIN sslm_life_cycle_stages slcs ON slcs.stage_id = slc.stage_id
        WHERE sph.tenant_id = #{tenantId}
          AND sph.pr_header_id = #{prHeaderId}
          AND slcs.allow_orders = 0
    </select>

    <select id="checkPrSupplierAllowOrderV2" resultType="org.srm.purchasecooperation.pr.domain.vo.SupplierStageVO">
        SELECT
            spl.supplier_company_name,
            slcs.stage_description,
            slcs.allow_orders
        FROM
            sprm_pr_header sph
            JOIN sprm_pr_line spl ON sph.pr_header_id = spl.pr_header_id
            LEFT JOIN sslm_life_cycle slc ON slc.tenant_id = sph.tenant_id
            AND slc.company_id = sph.company_id
            AND slc.supplier_tenant_id = spl.supplier_tenant_id
            AND slc.supplier_company_id = spl.supplier_company_id
            LEFT JOIN sslm_life_cycle_stages slcs ON slcs.stage_id = slc.stage_id
        WHERE
            sph.tenant_id = #{tenantId}
          AND sph.pr_header_id = #{prHeaderId}
    </select>

    <select id="selectUnitByUnitId" resultType="org.srm.purchasecooperation.pr.domain.vo.UnitVO">
        select
            hu.unit_id,
            hu.unit_code,
            hu.unit_name
        from
            hpfm_unit hu
        where
            hu.unit_id = #{unitId}
    </select>

    <select id="selectMallOrderNumById" resultType="java.lang.String">
        SELECT mall_order_num
        FROM sprm_pr_header
        WHERE pr_header_id = #{prHeaderId}
    </select>

    <select id="selectPrNumsByMallOrderNumsAndTenantId" resultType="java.lang.String">
        SELECT
               pr_num
        FROM
             sprm_pr_header
        WHERE
              tenant_id = #{tenantId}
        and mall_order_num = #{mallOrderNum}
    </select>

    <!--1.采购申请头的状态为【已审批】且行执行状态为【已分配】，取消标识为否，关闭标识为否。
        2.单据来源为「SRM」「ERP」和「商城申请」的采购申请，行需有物料编码。「目录化」「电商」不需要此校验。
        3.采购申请自动分配或手工分配自动触发转单程序。
     -->
    <select id="selectCanAutoPrToPoDate" resultType="org.srm.purchasecooperation.pr.domain.entity.PrHeader">
        <bind name="now" value="@org.apache.commons.lang3.time.DateUtils@truncate(new java.util.Date(), @java.util.Calendar@SECOND)"/>
<!--        SELECT-->
<!--        <include refid="Base_Column_List"/>-->
<!--        FROM-->
<!--        sprm_pr_header sph-->
<!--        WHERE-->
<!--        sph.pr_status_code = 'APPROVED'-->
<!--        AND EXISTS ( SELECT sprl.pr_line_id FROM sprm_pr_line sprl WHERE sprl.pr_header_id = sph.pr_header_id AND sprl.assigned_flag = 1 )-->
        SELECT
        <include refid="Base_Column_List"/>,
        sacp.auto_change_id,
        sacp.batch_num
        FROM
        sprm_pr_header sph
        join sprm_pr_line spl on  spl.pr_header_id = sph.pr_header_id
        join sodr_auto_change_po sacp on sacp.source_header_id = sph.pr_header_id
        and sacp.source_line_id = spl.pr_line_id
        WHERE
        sph.pr_status_code = 'APPROVED'
        AND EXISTS (
        SELECT
        sprl.pr_line_id
        FROM
        sprm_pr_line sprl
        WHERE
        sprl.pr_header_id = sph.pr_header_id
        AND sprl.assigned_flag = 1
        AND sprl.cancelled_flag = 0
        AND sprl.closed_flag = 0
        AND ( sprl.execution_strategy_code = 'ORDER' OR sprl.execution_strategy_code IS NULL )
        )
        AND sph.close_status_code != 'CLOSED'
        AND sph.cancel_status_code != 'CANCELLED'
        and sacp.change_date &lt;= #{now}
        and sacp.is_change_flag = 0
        <choose>
            <when  test="_databaseId='mysql'">
                LIMIT #{batchCount}
            </when>
            <otherwise>
                rownum &lt;= #{batchCount}
            </otherwise>
        </choose>
    </select>

    <select id="selectCountCanAutoPrToPoDate" resultType="java.lang.Integer">
        <bind name="now" value="@org.apache.commons.lang3.time.DateUtils@truncate(new java.util.Date(), @java.util.Calendar@SECOND)"/>
        SELECT
        count (*)
        FROM
        sprm_pr_header sph
        join sprm_pr_line spl on  spl.pr_header_id = sph.pr_header_id
        join sodr_auto_change_po sacp on sacp.source_header_id = sph.pr_header_id
        and sacp.source_line_id = spl.pr_line_id
        WHERE
        sph.pr_status_code = 'APPROVED'
        AND EXISTS (
        SELECT
        sprl.pr_line_id
        FROM
        sprm_pr_line sprl
        WHERE
        sprl.pr_header_id = sph.pr_header_id
        AND sprl.assigned_flag = 1
        AND sprl.cancelled_flag = 0
        AND sprl.closed_flag = 0
        AND ( sprl.execution_strategy_code = 'ORDER' OR sprl.execution_strategy_code IS NULL )
        )
        AND sph.close_status_code != 'CLOSED'
        AND sph.cancel_status_code != 'CANCELLED'
        and sacp.change_date &lt;= #{now}
        and sacp.is_change_flag = 0
    </select>
    <select id="selectPcSubjectByPcNum" resultType="org.srm.purchasecooperation.pr.api.dto.PcHeaderChangeDto" >
        SELECT
            sph.pc_header_id AS pc_header_id ,
            sps.pc_subject_id AS pc_subject_id
        FROM
            spcm_pc_subject sps
            LEFT JOIN spcm_pc_header sph ON sps.pc_header_id = sph.pc_header_id
        WHERE
            sph.tenant_id = #{tenantId}
            AND sph.pc_num = #{pcNum}
            AND sps.line_num = #{lineNum}
            AND sph.pc_source_code = #{sourcrCode}
            AND sph.pc_status_code in ('EFFECTED', 'CONFIRMED', 'ARCHIVE')
    </select>
    <select id="selectPrLineInfoByPcHeaderIdAndSubjectId" resultType="org.srm.purchasecooperation.pr.api.dto.PrLineChangeDto">

	SELECT
        spl.pr_header_id AS pr_header_id,
	    spl.pr_line_id AS pr_line_id,
        hio.organization_id AS inv_organization_id,
        hio.organization_name AS  inv_organization_name,
        spl.receive_address,
        spl.requested_by,
        spl.pr_requested_name
    FROM
        sprm_pr_line spl
        LEFT JOIN sprm_pr_header sph ON spl.pr_header_id = sph.pr_header_id
        LEFT JOIN hpfm_inv_organization hio ON spl.inv_organization_id = hio.organization_id
        LEFT JOIN (
            SELECT
                spch.pr_header_id AS pr_header_id,
                spch.pr_line_id AS pr_line_id
            FROM
                sprm_pr_change_history spch
            WHERE
                spch.execute_bill_header_id =#{pcHeaderId}
                AND spch.execute_bill_line_id =#{pcSubjectId}
                AND spch.tenant_id = #{tenantId}
            LIMIT 1
          ) temp ON temp.pr_line_id = spl.pr_line_id
	  WHERE spl.pr_line_id = temp.pr_line_id
    </select>

    <select id="selectInvOrgIdByPcNum" resultType="org.srm.purchasecooperation.pr.api.dto.PrLineChangeDto">
        SELECT
            spl.pr_header_id AS pr_header_id,
            spl.pr_line_id AS pr_line_id,
            spl.inv_organization_id AS inv_organization_id,
            hio.organization_name AS  inv_organization_name,
            spl.receive_address,
            spl.requested_by,
            spl.pr_requested_name
        FROM
            (
        SELECT
               CASE WHEN srli.pr_line_id is not null THEN srli.pr_line_id ELSE  sbli.pr_line_id END AS pr_line_id
            FROM
                spcm_pc_subject spc
            LEFT JOIN spcm_pc_header sph  ON spc.pc_header_id = sph.pc_header_id
            LEFT JOIN ssrc_source_result ssr ON ssr.result_id = spc.source_line_num
            LEFT JOIN ssrc_rfx_line_item srli on srli.rfx_line_item_id=ssr.source_line_item_id AND ssr.source_from='RFX'
            LEFT JOIN ssrc_bid_line_item sbli on sbli.bid_line_item_id=ssr.source_line_item_id AND ssr.source_from='BID'
            WHERE
            spc.tenant_id = #{tenantId}
            AND sph.pc_num = #{pcNum}
            AND spc.line_num = #{lineNum}
                AND sph.pc_source_code = 'SEARCH_SOURCE_RESULT'
            AND (srli.pr_header_id is not null OR sbli.pr_header_id is not null)
            ORDER BY sph.version DESC limit 1 ) temp LEFT JOIN sprm_pr_line spl ON temp.pr_line_id = spl.pr_line_id
             LEFT JOIN hpfm_inv_organization hio ON spl.inv_organization_id = hio.organization_id
            WHERE spl.pr_line_id =  temp.pr_line_id
            group by
              spl.pr_header_id,
              spl.pr_line_id,
              spl.inv_organization_id,
              hio.organization_name,
              spl.receive_address,
              spl.requested_by,
              spl.pr_requested_name
    </select>
    <select id="selectInvOrgInfoByPcInfo" resultType="org.srm.purchasecooperation.pr.api.dto.PrLineChangeDto">

            SELECT
			  spl.pr_line_id AS pr_line_id,
			  spl.pr_header_id AS pr_header_id,
			  spl.inv_organization_id AS inv_organization_id,
			  hio.organization_name AS inv_organization_name,
			  spl.receive_address,
			  spl.requested_by,
			  spl.pr_requested_name
			FROM
              sprm_pr_line spl  LEFT JOIN hpfm_inv_organization hio ON spl.inv_organization_id = hio.organization_id
			WHERE
			  spl.pr_line_id = (
				SELECT
				  CASE
					WHEN srli.pr_line_id IS NOT NULL THEN srli.pr_line_id
					ELSE sbli.pr_line_id
				  END AS pr_line_id
				FROM
				  spcm_pc_subject spc
				  LEFT JOIN spcm_pc_header sph ON spc.pc_header_id = sph.pc_header_id
				  LEFT JOIN spcm_pc_header sph1 ON sph1.pc_header_id = sph.main_contract_id
				  LEFT JOIN ssrc_rfx_header srh ON srh.rfx_num = spc.source_code
				  LEFT JOIN ssrc_bid_header sbh ON sbh.bid_num = spc.source_code
				  LEFT JOIN ssrc_rfx_line_item srli ON srli.rfx_header_id = srh.rfx_header_id
				  LEFT JOIN ssrc_bid_line_item sbli ON sbli.bid_header_id = sbh.bid_header_id
				WHERE
				   spc.tenant_id = #{tenantId}
                AND sph.pc_num = #{pcNum}
                AND spc.line_num = #{lineNum}
                AND sph.pc_source_code = 'SEARCH_SOURCE_RESULT'
				  AND (
					srh.source_from = 'PROJECT'
					AND (
					  SELECT
						count(1)
					  FROM
						ssrc_project_line_item spli
						JOIN ssrc_project_line_item_dist splid ON splid.project_line_item_id = spli.project_line_item_id
						JOIN ssrc_rfx_line_item srli ON srli.rfx_line_item_id = splid.item_line_id
					  WHERE
						srli.rfx_header_id = srh.rfx_header_id
						AND spli.pr_header_id IS NOT NULL
					) > 0
				  )
				  union all
							SELECT
				  CASE
					WHEN srli.pr_line_id IS NOT NULL THEN srli.pr_line_id
					ELSE sbli.pr_line_id
				  END AS pr_line_id
				FROM
				  spcm_pc_subject spc
				  LEFT JOIN spcm_pc_header sph ON spc.pc_header_id = sph.pc_header_id
				  LEFT JOIN spcm_pc_header sph1 ON sph1.pc_header_id = sph.main_contract_id
				  LEFT JOIN ssrc_rfx_header srh ON srh.rfx_num = spc.source_code
				  LEFT JOIN ssrc_bid_header sbh ON sbh.bid_num = spc.source_code
				  LEFT JOIN ssrc_rfx_line_item srli ON srli.rfx_header_id = srh.rfx_header_id
				  LEFT JOIN ssrc_bid_line_item sbli ON sbli.bid_header_id = sbh.bid_header_id
				WHERE
				   spc.tenant_id = #{tenantId}
					AND sph.pc_num = #{pcNum}
					AND spc.line_num = #{lineNum}
					AND sph.pc_source_code = 'SEARCH_SOURCE_RESULT'
						AND (
					sbh.source_from = 'PROJECT'
					AND (
					  SELECT
						count(1)
					  FROM
						ssrc_project_line_item spli
						JOIN ssrc_project_line_item_dist splid ON splid.project_line_item_id = spli.project_line_item_id
						JOIN ssrc_bid_line_item sbli ON sbli.bid_line_item_id = splid.item_line_id
					  WHERE
						sbli.bid_header_id = sbh.bid_header_id
						AND spli.pr_header_id IS NOT NULL
					) > 0
				  )
				LIMIT
				  1
			  )
    </select>
    <select id="selectPcLiXunByResultId" resultType="org.srm.purchasecooperation.pr.domain.entity.PrLine">
        SELECT
            spl.pr_line_id,
            spl.receive_address,
            spl.requested_by,
            spl.pr_requested_name
        FROM
            (
            SELECT
            CASE

                WHEN
                    srli.pr_line_id IS NOT NULL THEN
                        srli.pr_line_id ELSE sbli.pr_line_id
                        END AS pr_line_id
                FROM
                    ssrc_source_result ssr
                    LEFT JOIN ssrc_rfx_header srh ON srh.rfx_num = ssr.source_num
                    LEFT JOIN ssrc_bid_header sbh ON sbh.bid_num = ssr.source_num
                    LEFT JOIN ssrc_rfx_line_item srli ON srli.rfx_line_item_id = ssr.source_line_item_id
                    AND ssr.source_from = 'RFX'
                    LEFT JOIN ssrc_bid_line_item sbli ON sbli.bid_line_item_id = ssr.source_line_item_id
                    AND ssr.source_from = 'BID'
                WHERE
                     ssr.tenant_id = #{tenantId}
                    AND ssr.result_id = #{resultId}
                    AND ( srli.pr_header_id IS NOT NULL OR sbli.pr_header_id IS NOT NULL )
                AND ( srh.source_from = 'PROJECT' OR sbh.source_from = 'PROJECT' )) temp
                LEFT JOIN sprm_pr_line spl ON temp.pr_line_id = spl.pr_line_id
        WHERE
            spl.pr_line_id = temp.pr_line_id
    </select>
    <select id="selectPcXunByResultId" resultType="org.srm.purchasecooperation.pr.domain.entity.PrLine">
        SELECT
            spl.pr_line_id,
            spl.receive_address,
            spl.requested_by,
            spl.pr_requested_name
        FROM
            (
            SELECT
            CASE

                WHEN
                    srli.pr_line_id IS NOT NULL THEN
                        srli.pr_line_id ELSE sbli.pr_line_id
                        END AS pr_line_id
                FROM
                    ssrc_source_result ssr
                    LEFT JOIN ssrc_rfx_line_item srli ON srli.rfx_line_item_id = ssr.source_line_item_id
                    AND ssr.source_from = 'RFX'
                    LEFT JOIN ssrc_bid_line_item sbli ON sbli.bid_line_item_id = ssr.source_line_item_id
                    AND ssr.source_from = 'BID'
                WHERE
                     ssr.tenant_id = #{tenantId}
                    AND ssr.result_id = #{resultId}
                    AND ( srli.pr_header_id IS NOT NULL OR sbli.pr_header_id IS NOT NULL )) temp
                LEFT JOIN sprm_pr_line spl ON temp.pr_line_id = spl.pr_line_id
        WHERE
            spl.pr_line_id = temp.pr_line_id
    </select>

    <select id="selectCopyPrHeaderFields" resultType="org.srm.purchasecooperation.pr.domain.entity.PrHeader">
        select
            ${headCopyFields}
        from
            sprm_pr_header
        where
            pr_header_id = #{prHeaderId}
    </select>

    <select id="selectCopyPrHeaderDetail" resultType="org.srm.purchasecooperation.pr.domain.entity.PrHeader">
        select
            sph.tenant_id,
            sph.pr_num,
            sph.display_pr_num,
            sph.pr_status_code,
            sph.previous_pr_status_code,
            sph.title,
            sph.request_date,
            sph.amount,
            sph.unit_id,
            sph.unit_name,
            sph.freight,
            sph.requested_by,
            sph.pr_requested_name,
            sph.contact_tel_num,
            sph.company_id,
            sph.ou_id,
            sph.purchase_org_id,
            sph.purchase_agent_id,
            sph.pr_source_platform,
            sph.lot_num,
            sph.receiver_address_id,
            sph.receiver_region_id,
            sph.receiver_contact_name,
            sph.receiver_tel_num,
            sph.invoice_address_id,
            sph.invoice_region_id,
            sph.invoice_contact_name,
            sph.invoice_tel_num,
            sph.receiver_email_address,
            sph.invoice_title,
            sph.tax_register_num,
            sph.tax_register_address,
            sph.tax_register_tel,
            sph.tax_register_bank,
            sph.tax_register_bank_account,
            sph.invoice_method_code,
            sph.invoice_type_code,
            sph.invoice_title_type_code,
            sph.invoice_detail_type_code,
            sph.close_status_code,
            sph.cancel_status_code,
            sph.ec_preorder_num,
            sph.ec_error_flag,
            sph.ec_check_response_msg,
            sph.attachment_uuid,
            sph.remark,
            sph.approved_remark,
            sph.approved_by,
            sph.approved_date,
            sph.sync_response_msg,
            sph.sync_by,
            sph.sync_date,
            sph.sync_remark,
            sph.sync_status,
            sph.execution_status_code,
            sph.executed_date,
            sph.execution_bill_id,
            sph.executed_by,
            sph.execution_bill_num,
            sph.execution_bill_data,
            sph.mall_order_num,
            sph.payment_method_code,
            sph.payment_method_name,
            sph.receiver_address,
            sph.invoice_address,
            sph.platform_code,
            sph.invoice_method_name,
            sph.invoice_type_name,
            sph.invoice_title_type_name,
            sph.invoice_detail_type_name,
            sph.urgent_date,
            sph.evaluate_flag,
            sph.satisfaction_degree_code,
            sph.evaluate_remark,
            sph.evaluate_by,
            sph.evaluate_date,
            sph.urgent_flag,
            sph.pr_type_id,
            sph.parent_unit_id,
            sph.category_id,
            sph.accepter_user_id,
            sph.tech_guidance_flag,
            sph.tech_director_user_id,
            sph.inventory_id,
            sph.expense_unit_id,
            sph.expense_unit_name,
            sph.invoice_company_id,
            sph.external_num,
            sph.external_approving_flag,
            sph.new_mall_flag,
            sph.changed_flag,
            sph.original_currency
        from
            sprm_pr_header sph
        where
            sph.pr_header_id = #{prHeaderId}
        and sph.tenant_id = #{tenantId}
    </select>
    <select id="selectPrLocalCurrencyCode" resultType="java.lang.String">
    SELECT
	    sc.currency_code
    FROM
	    hpfm_company hc
	JOIN ( SELECT MAX( version_number ) version_number, company_id FROM spfm_company_basic WHERE process_status = 'COMPLETE' GROUP BY company_id ) scba_max ON scba_max.company_id = hc.source_key
	join spfm_company_basic scb on scb.company_id = hc.source_key and scb.version_number = scba_max.version_number
	LEFT JOIN smdm_currency sc ON sc.currency_id = scb.currency_id
	where hc.company_id =#{companyId}
	and hc.tenant_id=#{tenantId}
    </select>

    <select id="selectMdmAccurate" resultType="org.srm.purchasecooperation.pr.api.dto.PrHeaderCurrencyDto">
               SELECT
                default_precision,
                financial_precision
            FROM
                    smdm_currency
                WHERE
                    currency_code = #{currencyCode}
                    AND enabled_flag = 1
                    AND tenant_id = #{tenantId}

    </select>

    <select id="selectWorkbenchPrSummaries" parameterType="org.srm.purchasecooperation.pr.api.dto.PrHeaderDTO"
            resultType="org.srm.purchasecooperation.pr.domain.vo.PrHeaderVO">
        <bind name="lang" value="@io.choerodon.mybatis.helper.LanguageHelper@language()"/>
        SELECT
        <include refid="Base_Column_List"/>
        ,
        scbl.company_name,
        hou.ou_name,
        hpo.organization_name AS purchase_org_name,
        sph.pr_type_id,
        spt.pr_type_code,
        sptl.pr_type_name,
        sph.parent_unit_id,
        hu.unit_name as parent_unit_name,
        sph.invoice_company_id,
        iua.real_name as accepter_user_name,
        iut.real_name as tech_director_user_name,
        hi.inventory_name,
        sph.expense_unit_id,
        sph.expense_unit_name,
        hpa.purchase_agent_name,
        CASE
        WHEN sph.evaluate_flag IS NULL THEN 0
        ELSE sph.evaluate_flag
        END evaluate_flag,
        sph.satisfaction_degree_code,
        sph.evaluate_remark,
        sph.evaluate_by,
        sph.evaluate_date,
        iur.login_name as pr_requested_num,
        iuz.real_name as create_by_name
        FROM sprm_pr_header sph
        LEFT JOIN hpfm_company hc ON sph.company_id = hc.company_id
        LEFT JOIN (SELECT MAX(version_number) version_number,company_id FROM spfm_company_basic WHERE process_status = 'COMPLETE' GROUP BY company_id) scba_max
        on scba_max.company_id=hc.source_key
        LEFT JOIN spfm_company_basic scb ON scb.company_id = scba_max.company_id AND scba_max.version_number = scb.version_number
        LEFT JOIN spfm_company_basic_tl scbl ON scb.company_basic_id = scbl.company_basic_id
        AND scbl.lang = #{lang}
        LEFT JOIN hpfm_operation_unit hou ON sph.ou_id = hou.ou_id
        LEFT JOIN hpfm_purchase_organization hpo ON sph.purchase_org_id = hpo.purchase_org_id
        LEFT JOIN hpfm_purchase_agent hpa ON sph.purchase_agent_id = hpa.purchase_agent_id
        LEFT JOIN hpfm_unit hu ON sph.parent_unit_id = hu.unit_id
        LEFT JOIN sprm_pr_type spt ON sph.pr_type_id = spt.pr_type_id
        LEFT JOIN sprm_pr_type_tl sptl ON sptl.pr_type_id = spt.pr_type_id AND sptl.lang = #{lang}
        LEFT JOIN iam_user iua ON iua.id = sph.accepter_user_id
        LEFT JOIN iam_user iut ON iut.id = sph.tech_director_user_id
        LEFT JOIN iam_user iuz ON iuz.id = sph.created_by
        LEFT JOIN iam_user iur ON iur.id = sph.requested_by
        LEFT JOIN hpfm_inventory hi ON hi.inventory_id = sph.inventory_id
        WHERE sph.tenant_id = #{tenantId}
        <if test=" prTypeId!= null">
            AND sph.pr_type_id = #{prTypeId}
        </if>
        <if test="prHeaderIds != null and prHeaderIds.size() gt 0">
            AND sph.pr_header_id IN
            <foreach collection="prHeaderIds" index="index" item="prHeaderId" open="(" separator="," close=")">
                #{prHeaderId}
            </foreach>
        </if>
        <if test="prWorkbenchTabCode != null and prWorkbenchTabCode == 'APPROVED'">
            AND (
            CASE
                WHEN sph.pr_status_code = 'REJECTED' AND sph.changed_flag = 1 THEN 1
                WHEN sph.pr_status_code = 'APPROVED' THEN 1
                ELSE 0
            END
            ) = 1
        </if>
        <choose>
            <when test="prStatusCode != null and prStatusCode != ''">
                AND sph.pr_status_code = #{prStatusCode}
            </when>
            <otherwise>
                <if test="prStatusCodeList != null and prStatusCodeList.size() gt 0">
                    AND sph.pr_status_code IN
                    <foreach collection="prStatusCodeList" item="statusCode" open="(" close=")" separator=",">
                        #{statusCode}
                    </foreach>
                </if>
            </otherwise>
        </choose>
        <if test="purchasePlatformQueryParam1 != null and purchasePlatformQueryParam1 != ''">
            <bind name="purchasePlatformQueryParam1Like" value="'%'+purchasePlatformQueryParam1 +'%'"/>
            AND (sph.display_pr_num LIKE #{purchasePlatformQueryParam1Like}
            OR sph.title LIKE #{purchasePlatformQueryParam1Like}
            OR iuz.real_name LIKE #{purchasePlatformQueryParam1Like})
        </if>
        <if test="creatorName != null and creatorName != ''">
            <bind name="creatorNameLike" value="'%'+creatorName +'%'"/>
            AND iuz.real_name LIKE #{creatorNameLike}
        </if>
        <if test="companyId != null">
            AND sph.company_id = #{companyId}
        </if>
        <if test="purchaseOrgId != null">
            AND sph.purchase_org_id = #{purchaseOrgId}
        </if>
        <if test="displayPrNum != null and displayPrNum != ''">
            <bind name="displayPrNumLike" value="'%'+displayPrNum +'%'"/>
            AND(sph.display_pr_num LIKE #{displayPrNumLike}
            OR sph.pr_num LIKE #{displayPrNumLike})
        </if>
        <if test="displayPrNumList != null and displayPrNumList.size() > 0">
            AND sph.display_pr_num IN
            <foreach collection="displayPrNumList" item="displayPr" open="(" close=")" separator=",">
                #{displayPr}
            </foreach>
        </if>
        <if test="requestDateStart != null">
            AND sph.request_date &gt;= #{requestDateStart}
        </if>
        <if test="requestDateEnd != null">
            AND sph.request_date &lt;= #{requestDateEnd}
        </if>
        <if test="urgentFlag != null">
            AND sph.urgent_flag = #{urgentFlag}
        </if>
        <if test="prRequestedName != null and prRequestedName != ''">
            <bind name="prRequestedNameLike" value="'%'+prRequestedName +'%'"/>
            AND sph.pr_requested_name LIKE #{prRequestedNameLike}
        </if>
        <if test="purchaseAgentId != null">
            AND sph.purchase_agent_id = #{purchaseAgentId}
        </if>
        <if test="purchaseAgentName != null and purchaseAgentName != ''">
            <bind name="purchaseAgentNameLike" value="'%'+purchaseAgentName +'%'"/>
            AND hpa.purchase_agent_name LIKE #{purchaseAgentNameLike}
        </if>
        <if test="prSourcePlatform != null and prSourcePlatform != ''">
            AND sph.pr_source_platform = #{prSourcePlatform}
        </if>
        <if test="closeStatusCode != null and closeStatusCode != ''">
            AND sph.close_status_code = #{closeStatusCode}
        </if>
        <if test="closeStatusCode != null and closeStatusCode != ''">
            AND sph.close_status_code = #{closeStatusCode}
        </if>
        <if test="prCloseStatusList != null and prCloseStatusList.size() gt 0">
            AND sph.close_status_code IN
            <foreach collection="prCloseStatusList" item="statusCode" open="(" close=")" separator=",">
                #{statusCode}
            </foreach>
        </if>
        <if test="cancelStatusCode != null and cancelStatusCode != ''">
            AND sph.cancel_status_code = #{cancelStatusCode}
        </if>
        <if test="prCancelStatusList != null and prCancelStatusList.size() gt 0">
            AND sph.cancel_status_code IN
            <foreach collection="prCancelStatusList" item="statusCode" open="(" close=")" separator=",">
                #{statusCode}
            </foreach>
        </if>
        <if test="creationDateFrom !=null">
            AND sph.creation_date >= #{creationDateFrom}
        </if>
        <if test="creationDateTo !=null">
            AND sph.creation_date &lt; #{creationDateTo}
        </if>
        <if test="lotNum != null">
            AND sph.lot_num = #{lotNum}
        </if>
        <if test="unitId != null">
            AND sph.unit_id = #{unitId}
        </if>
        <if test="title != null and title != ''">
            <bind name="titleLike" value="'%'+title+'%'"/>
            AND sph.title LIKE #{titleLike}
        </if>
    </select>


    <select id="selectPrHeaderByPrNumAndTenantId" resultType="org.srm.purchasecooperation.pr.domain.entity.PrHeader">
        SELECT
        <include refid="Base_Column_List"/>
        FROM
        sprm_pr_header sph
        WHERE
        sph.tenant_id = #{tenantId}
        and sph.mall_pr_num = #{mallPrNum}
    </select>

    <update id="updateMsgResponse">
        update sprm_pr_header set
            attribute_longtext10 = #{attributeLongtext10}
            where pr_header_id = #{prHeaderId}
    </update>
</mapper>
