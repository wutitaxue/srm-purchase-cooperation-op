<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="org.srm.purchasecooperation.cux.order.infra.mapper.RcwlMyPoHeaderMapper">
    <select id="rcwlSelect" resultType="java.lang.String">
         SELECT
        case when
        ( SELECT sum( t.net_received_quantity ) FROM sodr_po_line_location t WHERE t.po_header_id = sph3.po_header_id ) > 0 and not EXISTS (select 1 from sslm_kpi_eval_header skeh where skeh.attribute_varchar2 = sph3.po_num) THEN
        1 ELSE 0
        END
        FROM
        sodr_po_header sph3
        WHERE
        sph3.po_header_id = #{poHeaderId}

    </select>

    <select id="selectPrHeader" resultType="org.srm.purchasecooperation.order.domain.vo.PoHeaderSingleReferenceVO">
        SELECT
        sph.pr_header_id,
        sph.pr_num,
        sph.title,
        sph.request_date,
        sph.pr_source_platform,
        hou.ou_name,
        hpo.organization_name,
        hpa.purchase_agent_name,
        hc.company_name,
        iu.real_name requested_name,
        sph.urgent_flag,
        sph.urgent_date,
        sph.pr_type_id
        FROM
        sprm_pr_header sph
        LEFT JOIN hpfm_purchase_agent hpa ON sph.purchase_agent_id = hpa.purchase_agent_id
        LEFT JOIN hpfm_purchase_organization hpo ON sph.purchase_org_id = hpo.purchase_org_id
        LEFT JOIN hpfm_operation_unit hou ON sph.ou_id = hou.ou_id
        LEFT JOIN iam_user iu ON sph.requested_by = iu.id
        LEFT JOIN hpfm_company hc ON sph.company_id = hc.company_id
        where 1 = 1
        <!--  状态为审批通过 -->
        and sph.pr_status_code = 'APPROVED'
        <!--  关闭状态为未关闭 -->
        and sph.close_status_code != 'CLOSED'
        <!--  取消状态为未取消 -->
        and sph.cancel_status_code = 'UNCANCELLED'
        <!--  来源平台为电商商城 -->
        and sph.pr_source_platform = 'E-COMMERCE'
        and sph.tenant_id = #{tenantId, jdbcType=DECIMAL}
        <if test="dto != null">
            <if test="dto.prNum != null and dto.prNum != ''">
                <bind name="prNumLike" value="'%'+dto.prNum +'%'"></bind>
                and sph.pr_num like #{prNumLike}
            </if>
            <if test="dto.title != null and dto.title != ''">
                <bind name="titleLike" value="'%'+dto.title +'%'"></bind>
                and sph.title like #{titleLike}
            </if>
            <if test="dto.requestDateFrom != null">
                and sph.request_date &gt;= #{dto.requestDateFrom}
            </if>
            <if test="dto.requestDateTo != null">
                and sph.request_date &lt;= #{dto.requestDateTo}
            </if>
            <if test="dto.ouId != null">
                and sph.ou_id = #{dto.ouId}
            </if>
            <if test="dto.purchaseOrgId != null">
                and sph.purchase_org_id = #{dto.purchaseOrgId}
            </if>
            <if test="dto.companyId != null">
                and sph.company_id = #{dto.companyId}
            </if>
            <if test="dto.purchaseAgentId != null">
                and sph.purchase_agent_id = #{dto.purchaseAgentId}
            </if>
            <if test="dto.sourceCode != null and dto.sourceCode != ''">
                and sph.pr_source_platform = #{dto.sourceCode}
            </if>
            <if test="dto.requestedBy != null">
                and sph.requested_by = #{dto.requestedBy}
            </if>
            <if test="dto.urgentFlag != null">
                AND sph.urgent_flag = #{dto.urgentFlag}
            </if>
            <if test="dto.prTypeId != null">
                AND sph.pr_type_id = #{dto.prTypeId}
            </if>
            <if test="dto.supplierId != null or dto.supplierCompanyId != null">
                and sph.pr_header_id in (
                SELECT
                spl.pr_header_id
                FROM sprm_pr_line spl
                where 1 = 1
                <if test="dto.supplierId != null">
                    and spl.supplier_id = #{dto.supplierId}
                </if>
                <if test="dto.supplierCompanyId != null">
                    and spl.supplier_company_id = #{dto.supplierCompanyId}
                </if>
                group by spl.pr_header_id)
            </if>
        </if>
        ORDER BY sph.pr_num DESC
    </select>
    <select id="rcwlSelectHeaderdetail" resultType="org.srm.purchasecooperation.order.api.dto.PoHeaderDetailDTO">

        <bind name="userDetails" value="@io.choerodon.core.oauth.DetailsHelper@getUserDetails()"/>
        <bind name="lang" value="@io.choerodon.mybatis.helper.LanguageHelper@language()"/>
        SELECT
        sph.tenant_id,
        sph.po_header_id,
        sph.pr_header_id,
        sph.po_num,
        sph.ou_id,
        sph.release_num,
        sph.version_num,
        sph.amount,
        sph.tax_include_amount,
        sph.source_bill_type_code,
        sph.ship_to_loc_cont_name,
        sph.ship_to_loc_tel_num,
        sph.bill_to_loc_cont_name,
        sph.bill_to_loc_tel_num,
        sph.created_by,
        iu.login_name created_name,
        sph.receiver_email_address,
        sph.tax_register_address,
        sph.tax_register_num,
        sph.tax_register_bank,
        sph.tax_register_bank_account,
        sph.invoice_title,
        sph.tax_register_tel,
        sph.invoice_type_code,
        sph.invoice_method_code,
        sph.invoice_title_type_code,
        sph.invoice_detail_type_code,
        sph.agent_id,
        sph.publish_cancel_flag,
        sph.closed_flag,
        sph.purchase_org_id,
        sph.attribute_varchar2,
        sph.attribute_bigint1,
        sph.attribute_date2,
        sph.attribute_date3,
        sot.return_order_flag,
        com.company_num,
        (
        CASE
        WHEN sph.company_name IS NULL THEN com.company_name
        ELSE sph.company_name
        END
        ) AS company_name,
        sph.company_id,
        sph.currency_code,
        sph.domestic_currency_code,
        (
        CASE
        WHEN sph.supplier_id IS NOT NULL AND sph.supplier_code IS NOT NULL THEN sph.supplier_code
        WHEN sph.supplier_id IS NOT NULL AND sph.supplier_code IS NULL THEN es.supplier_num
        ELSE scom.company_num
        END
        ) AS supplier_code,
        (
        CASE
        WHEN sph.supplier_id IS NOT NULL AND sph.supplier_name IS NOT NULL THEN sph.supplier_name
        WHEN sph.supplier_id IS NOT NULL AND sph.supplier_name IS NULL THEN es.supplier_name
        WHEN sph.supplier_id IS NULL AND sph.supplier_company_name IS NULL THEN scom.company_name
        ELSE sph.supplier_company_name
        END
        ) AS supplier_name,
        sph.supplier_id,
        sph.supplier_tenant_id,
        sph.status_code,
        sph.source_code,
        sph.domestic_amount,
        sph.domestic_tax_include_amount,

        sph.released_date,
        sph.ship_to_location_address,
        sph.bill_to_location_address,
        sph.attachment_uuid,
        sph.supplier_attachment_uuid,
        sph.purchaser_inner_attachment_uuid,
        sph.po_type_id,
        sph.supplier_company_id,
        sph.supplier_company_name,
        ou.ou_name,
        sph.delivery_sync_status,

        (SELECT
        spllo.delivery_sync_response_msg
        FROM
        sodr_po_line_location spllo
        WHERE
        spllo.po_header_id = #{poHeaderId,jdbcType=DECIMAL}
        and spllo.delivery_sync_status='FAIL'
        limit 1
        )  delivery_sync_response_msg,

        (SELECT
        spllo.delivery_sync_date
        FROM
        sodr_po_line_location spllo
        WHERE
        spllo.po_header_id = #{poHeaderId,jdbcType=DECIMAL}
        and spllo.delivery_sync_status='FAIL'
        limit 1
        )  delivery_sync_date,
        sph.terms_id,
        hpt.term_name AS  terms_name,
        hpa.purchase_agent_name AS agent_name,
        sott.order_type_name AS po_type_desc,
        sess.supplier_site_name AS supplier_site_name,
        hpo.organization_name AS purchase_org_name,
        sph.creation_date,
        sph.approved_sync_status,
        sph.approved_sync_response_msg,
        sph.approved_sync_date,
        sph.erp_contract_num,
        sph.remark,
        sph.frozen_flag,
        sph.display_po_num,
        sph.po_source_platform,
        sph.object_version_number,
        sph.invoice_type_name,
        sph.invoice_method_name,
        sph.invoice_title_type_name,
        sph.invoice_detail_type_name,
        (
        CASE
        WHEN  sppc.modifyable_price_flag = 1 AND sppc.only_lower_price_flag = 1 THEN -1
        WHEN  sppc.modifyable_price_flag = 1 AND sppc.only_lower_price_flag = 0 THEN 1
        WHEN  sppc.modifyable_price_flag = 0 THEN 0
        END
        )  modifyable_price_flag,
        sph.modify_price_flag,
        sph.confirmed_flag,
        sprhcom.mall_parent_order_num,
        sph.create_sync_status,
        sot.order_type_code,
        sph.un_save_enable,
        sph.original_po_header_id,
        sph2.display_po_num AS original_po_num,
        (SELECT
        max( spm.po_message_num ) -
        CASE
        WHEN ( SELECT COUNT(0) FROM sodr_po_msg_read_record spmrr WHERE spmrr.po_header_id = sph.po_header_id
        AND spmrr.user_id = #{userDetails.userId}
        AND spmrr.tenant_id = #{userDetails.tenantId}) = 0 THEN
        0 ELSE (SELECT
        spmrr.read_record_index
        FROM
        sodr_po_msg_read_record spmrr
        WHERE
        spmrr.po_header_id = sph.po_header_id
        AND spmrr.user_id = #{userDetails.userId}
        AND spmrr.tenant_id = #{userDetails.tenantId} ) END
        FROM
        sodr_po_message spm
        WHERE
        spm.po_header_id = sph.po_header_id) AS unread_count
        FROM
        sodr_po_header sph
        LEFT JOIN smdm_payment_term hpt on sph.terms_id = hpt.term_id
        LEFT JOIN iam_user iu on iu.id=sph.created_by
        LEFT JOIN sodr_order_type sot ON sph.po_type_id = sot.order_type_id
        LEFT JOIN sodr_order_type_tl sott ON sott.order_type_id = sot.order_type_id AND sott.lang = #{lang}
        LEFT JOIN hpfm_purchase_agent hpa ON sph.agent_id = hpa.purchase_agent_id
        LEFT JOIN sslm_ext_supplier_site sess on sph.supplier_site_id=sess.supplier_site_id
        LEFT JOIN hpfm_purchase_organization hpo ON sph.purchase_org_id = hpo.purchase_org_id
        LEFT JOIN sslm_external_supplier es on sph.supplier_id=es.supplier_id and es.tenant_id = sph.tenant_id
        LEFT JOIN hpfm_company hcc on hcc.company_id = es.link_id
        LEFT JOIN hpfm_company com on sph.company_id=com.company_id and com.tenant_id = sph.tenant_id
        LEFT JOIN spfm_partner sp ON sp.partner_company_id=sph.supplier_company_id AND sp.company_id=sph.company_id
        LEFT JOIN sslm_supplier_basic scom on scom.supplier_basic_id=sp.supplier_basic_id
        LEFT JOIN hpfm_operation_unit ou on sph.ou_id=ou.ou_id
        LEFT JOIN sprm_pr_header sprhcom ON sprhcom.pr_header_id=sph.pr_header_id
        LEFT JOIN sodr_po_price_change sppc on sph.tenant_id = sppc.tenant_id and sph.po_source_platform = sppc.po_source_platform
        LEFT JOIN sodr_po_header sph2 ON sph.original_po_header_id = sph2.po_header_id
        WHERE
        1 = 1
        AND sph.po_header_id = #{poHeaderId,jdbcType=DECIMAL}
        AND sph.tenant_id = #{tenantId,jdbcType=DECIMAL}
        <bind name="userDetails" value="@io.choerodon.core.oauth.DetailsHelper@getUserDetails()"/>
        <if test="userDetails != null and !userDetails.organizationId.equals(userDetails.tenantId)">
            and (sph.supplier_tenant_id=#{userDetails.organizationId} OR hcc.tenant_id=#{userDetails.organizationId})
        </if>
    </select>

    <select id = "selectPoHeader" resultType = "org.srm.purchasecooperation.order.domain.entity.PoHeader">
        <bind name="userDetails" value="@io.choerodon.core.oauth.DetailsHelper@getUserDetails()"/>
        <bind name="lang" value="@io.choerodon.mybatis.helper.LanguageHelper@language()"/>
        SELECT
        ph.delivery_sync_status,
        ph.delivery_sync_response_msg,
        ph.delivery_sync_date,
        (
        SELECT
        sum(
        CASE

        WHEN #{nowDate} > spllinfo.promise_delivery_date
        AND phs.confirmed_flag = 1
        AND phs.cancelled_flag = 0
        AND phs.closed_flag = 0
        AND phs.publish_cancel_flag = 0 THEN
        ( CASE spllinfo.quantity WHEN spllinfo.net_received_quantity THEN 0 ELSE 1 END ) ELSE 0
        END
        ) AS receive_status
        FROM
        sodr_po_line_location spllinfo
        LEFT JOIN sodr_po_header phs ON spllinfo.po_header_id = phs.po_header_id
        WHERE
        phs.po_header_id = ph.po_header_id
        group by phs.po_header_id
        ) beyond_quantity,
        ph.po_header_id,
        ph.tenant_id,
        ph.po_num,
        ph.version_num,
        ph.version_date,
        ph.po_type_id,
        ph.release_num,
        ph.display_po_num,
        ph.supplier_company_id,
        ph.supplier_company_name,
        ph.po_source_platform,
        ph.source_bill_type_code,
        ph.create_sync_date,
        ph.create_sync_response_msg,
        ph.create_sync_status,
        ph.change_sync_status,
        hsc.company_num AS supplier_company_code,
        com.company_num company_code,
        ou.ou_code,
        po.organization_code purchase_org_code,
        NULL supplier_category_id,
        NULL supplier_category_code ,
        NULL supplier_category_name,
        pa.purchase_agent_name AS agent_name,
        (
        CASE
        WHEN ph.supplier_id IS NOT NULL AND ph.supplier_code IS NOT NULL THEN ph.supplier_code
        WHEN ph.supplier_id IS NOT NULL AND ph.supplier_code IS NULL THEN es.supplier_num
        ELSE hsc.company_num
        END
        ) AS supplier_code,
        (
        CASE
        WHEN ph.supplier_id IS NOT NULL AND ph.supplier_name IS NOT NULL THEN ph.supplier_name
        WHEN ph.supplier_id IS NOT NULL AND ph.supplier_name IS NULL THEN es.supplier_name
        WHEN ph.supplier_id IS NULL AND ph.supplier_company_name IS NULL THEN hsc.company_name
        ELSE ph.supplier_company_name
        END
        ) AS supplier_name,
        ess.supplier_site_code AS supplier_site_code,
        ess.supplier_site_name AS supplier_site_name,
        ph.ship_to_location_code,
        ph.ship_to_location_address,
        ph.bill_to_location_code,
        ph.bill_to_location_address,
        pt.term_name AS terms_name,
        (
        CASE
        WHEN ph.company_name IS NULL THEN com.company_name
        ELSE ph.company_name
        END
        )AS company_name,
        ou.ou_name AS org_name,
        po.organization_name AS pur_organization_name,
        ph.submitted_by,
        ph.submitted_date,
        ph.released_flag,
        ph.release_type_code,
        ph.released_by,
        ph.released_date,
        ph.confirmed_flag,
        ph.confirm_type_code,
        ph.confirmed_by,
        ph.confirmed_date,
        ph.urgent_flag,
        ph.urgent_date,
        ph.feedback_date,
        ph.confirm_update_flag,
        ph.frozen_flag,
        ph.erp_approval_flag,
        ph.erp_status,
        ph.status_code,
        ph.source_code,
        ph.external_system_code,
        ph.currency_code,
        ph.domestic_currency_code,
        ph.amount,
        ph.tax_include_amount,
        ph.remark,
        ph.erp_creation_date,
        ph.creation_date,
        ph.created_by,
        ph.object_version_number,
        sot.order_type_code AS po_type_code,
        sot.return_order_flag,
        sott.order_type_name AS po_type_code_meaning,
        ph.cancelled_flag,
        ph.closed_flag,
        ph.publish_cancel_flag,
        ph.refused_flag,
        ph.incorrect_msg,
        ph.incorrect_flag,
        ph.approved_sync_status,
        ph.approved_sync_response_msg,
        ph.approved_sync_date,
        ph.attachment_uuid,
        ph.supplier_attachment_uuid,
        ph.erp_contract_num,
        sprhcom.mall_parent_order_num,
        usr.real_name,
        ph.original_po_header_id,
        ph.company_id,
        com.registered_country_id,
        sph2.display_po_num AS original_po_num,
        (SELECT
        max( spm.po_message_num ) -
        CASE
        WHEN ( SELECT COUNT(0) FROM sodr_po_msg_read_record spmrr WHERE spmrr.po_header_id = ph.po_header_id
        AND spmrr.user_id = #{userDetails.userId}
        AND spmrr.tenant_id = #{userDetails.tenantId}  ) = 0 THEN
        0 ELSE (SELECT
        spmrr.read_record_index
        FROM
        sodr_po_msg_read_record spmrr
        WHERE
        spmrr.po_header_id = ph.po_header_id
        AND spmrr.user_id = #{userDetails.userId} ) END
        FROM
        sodr_po_message spm
        WHERE
        spm.po_header_id = ph.po_header_id) AS unread_count
        FROM
        sodr_po_header ph
        LEFT JOIN sodr_order_type sot on ph.po_type_id = sot.order_type_id
        LEFT JOIN sodr_order_type_tl sott ON sott.order_type_id = sot.order_type_id AND sott.lang = #{lang}
        LEFT JOIN smdm_payment_term pt on ph.terms_id = pt.term_id
        LEFT JOIN sslm_external_supplier es on ph.supplier_id = es.supplier_id
        LEFT JOIN hpfm_company hsesc ON hsesc.company_id = es.link_id
        LEFT JOIN hpfm_purchase_agent pa on ph.agent_id = pa.purchase_agent_id
        LEFT JOIN hpfm_operation_unit ou on ph.ou_id = ou.ou_id
        LEFT JOIN hpfm_purchase_organization po on ph.purchase_org_id = po.purchase_org_id
        LEFT JOIN sslm_ext_supplier_site ess on ph.supplier_site_id = ess.supplier_site_id
        LEFT JOIN hpfm_company com on ph.company_id = com.company_id
        LEFT JOIN spfm_partner sp ON sp.partner_company_id=ph.supplier_company_id AND sp.company_id=ph.company_id AND sp.tenant_id = ph.tenant_id AND sp.partner_tenant_id = ph.supplier_tenant_id
        LEFT JOIN sslm_supplier_basic hsc ON sp.supplier_basic_id = hsc.supplier_basic_id
        LEFT JOIN sprm_pr_header sprhcom ON sprhcom.pr_header_id=ph.pr_header_id
        LEFT JOIN iam_user usr on ph.created_by = usr.id
        LEFT JOIN sodr_po_header sph2 ON ph.original_po_header_id = sph2.po_header_id
        WHERE
        1 = 1
        <include refid="selectPoHeaderCondition"/>
    </select>

    <sql id="selectPoHeaderCondition">
        <if test = "poNum != null">
            <bind name = "poNumLike" value = "'%'+poNum +'%'"></bind>
            AND ph.po_num LIKE #{poNumLike}
        </if>
        <if test = "mallParentOrderNum != null">
            <bind name = "mallParentOrderNumLike" value = "'%'+mallParentOrderNum +'%'"></bind>
            AND sprhcom.mall_parent_order_num LIKE #{mallParentOrderNumLike}
        </if>

        <if test = "companyId != null">
            AND ph.company_id = #{companyId}
        </if>
        <if test = "agentName != null and agentName != '' and agentIds == null">
            <bind name = "agentNameLike" value = "'%'+ agentName +'%'"></bind>
            AND pa.purchase_agent_name like #{agentNameLike}
        </if>
        <if test="agentIds != null and agentIds != '' ">
            and ph.agent_id in (
            <foreach collection="agentIds.split(',') " separator="," item="agentIdItem">
                #{agentIdItem}
            </foreach>)
        </if>
        <if test="purchaseOrgIds != null and purchaseOrgIds != ''">
            and ph.purchase_org_id in (
            <foreach collection="purchaseOrgIds.split(',') " separator="," item="purchaseOrgIdItem">
                #{purchaseOrgIdItem}
            </foreach>)
        </if>
        <if test = "poTypeId != null">
            AND ph.po_type_id = #{poTypeId}
        </if>
        <if test = "supplierId != null">
            and es.supplier_id = #{supplierId}
        </if>
        <if test="supplierIds != null and supplierIds.size() > 0">
            and es.supplier_id IN
            <foreach collection="supplierIds" open="(" close=")" separator="," item="supplierId">
                #{supplierId}
            </foreach>
        </if>
        <if test = "agentId != null">
            AND ph.agent_id = #{agentId}
        </if>
        <if test = "erpStatus != null and erpStatus != ''">
            AND ph.erp_status = #{erpStatus}
        </if>
        <if test = "confirmedFlag != null ">
            AND ph.confirmed_flag = #{confirmedFlag}
        </if>
        <if test = "releaseNum != null">
            <bind name = "releaseNumLike" value = "'%'+ releaseNum +'%'"></bind>
            AND ph.release_num LIKE #{releaseNumLike}
        </if>
        <if test = "supplierSiteId != null">
            AND ph.supplier_site_id = #{supplierSiteId}
        </if>
        <if test = "urgentFlag != null">
            AND ph.urgent_flag = #{urgentFlag}
        </if>
        <if test = "submitDateStart != null">
            AND ph.submitted_date &gt;= #{submitDateStart}
        </if>
        <if test = "submitDateEnd != null">
            AND ph.submitted_date &lt; #{submitDateStart}
        </if>
        <if test = "releaseDateStart != null">
            AND ph.released_date &gt;= #{releaseDateStart}
        </if>
        <if test = "releaseDateEnd != null">
            AND ph.released_date &lt; #{releaseDateEnd}
        </if>
        <if test = "confirmDateStart != null">
            AND ph.confirmed_date &gt;= #{confirmDateStart}
        </if>
        <if test = "confirmDateEnd != null">
            AND ph.confirmed_date &lt; #{confirmDateEnd}
        </if>
        <if test = "creationDateStart != null">
            AND ph.creation_date &gt;= #{creationDateStart}
        </if>
        <if test = "creationDateEnd != null">
            AND ph.creation_date &lt; #{creationDateEnd}
        </if>
        <if test = "feedbackDateStart != null">
            and ph.feedback_date &gt;= #{feedbackDateStart}
        </if>
        <if test = "feedbackDateEnd != null">
            and ph.feedback_date &lt; #{feedbackDateEnd}
        </if>
        <if test = "tenantId != null">
            AND ph.tenant_id = #{tenantId}
        </if>
        <if test = "releasedFlag != null">
            AND ph.released_flag = #{releasedFlag}
        </if>
        <if test = "remark != null and remark != ''">
            <bind name = "remarkLike" value = "'%' + remark + '%'"></bind>
            AND ph.remark LIKE #{remarkLike}
        </if>
        <if test = "submittedBy != null and submittedBy != ''">
            <bind name = "submittedByLike" value = "'%'+ submittedBy + '%'"></bind>
            AND ph.submitted_by LIKE #{submittedByLike}
        </if>
        <if test = "releasedBy != null and releasedBy != ''">
            <bind name = "releasedByLike" value = "'%'+ releasedBy  + '%'"></bind>
            AND ph.released_by LIKE #{releasedByLike}
        </if>
        <if test = "confirmedBy != null and confirmedBy != ''">
            <bind name = "confirmedByLike" value = "'%'+  confirmedBy + '%'"></bind>
            AND ph.confirmed_by LIKE #{confirmedByLike}
        </if>
        <if test = "companyId != null">
            AND ph.company_id = #{companyId}
        </if>
        <if test = "poHeaderId != null">
            AND ph.po_header_id = #{poHeaderId}
        </if>
        <if test = "billToLocationAddress != null and billToLocationAddress != ''">
            <bind name = "billToLocationNameLike" value = "'%'+  billToLocationAddress + '%'"></bind>
            AND ph.bill_to_location_address LIKE #{billToLocationNameLike}
        </if>
        <if test = "billToLocationCode != null and billToLocationCode != ''">
            <bind name = "billToLocationCodeLike" value = "'%'+  billToLocationCode + '%'"></bind>
            AND ph.bill_to_location_code LIKE #{billToLocationCodeLike}
        </if>
        <if test = "shipToLocationCode != null and shipToLocationCode != ''">
            <bind name = "shipToLocationCodeLike" value = "'%'+  shipToLocationCode + '%'"></bind>
            AND ph.ship_to_location_code LIKE #{shipToLocationCodeLike}
        </if>
        <if test = "shipToLocationAddress != null and shipToLocationAddress != ''">
            <bind name = "shipToLocationNameLike" value = "'%'+  shipToLocationAddress + '%'"></bind>
            AND ph.ship_to_location_address LIKE #{shipToLocationNameLike}
        </if>
        <if test = "sourceCode != null and sourceCode != ''">
            <bind name = "sourceCodeLike" value = "'%' + sourceCode + '%'"></bind>
            AND ph.source_code LIKE #{sourceCodeLike}
        </if>
        <if test = "supplierCompanyId != null">
            AND ph.supplier_company_id = #{supplierCompanyId}
        </if>
        <if test="supplierCompanyIds != null and supplierCompanyIds.size() > 0">
            AND ph.supplier_company_id IN
            <foreach collection="supplierCompanyIds" open="(" close=")" separator="," item="supplierCompanyId">
                #{supplierCompanyId}
            </foreach>
        </if>
        <if test = "poSourcePlatform != null">
            AND ph.po_source_platform = #{poSourcePlatform}
        </if>
        <if test = "userId != null">
            AND usr.id = #{userId}
        </if>
        <if test = "agentId != null">
            and ph.agent_id = #{agentId}
        </if>
        <if test = "refusedFlag != null">
            and ph.refused_flag = #{refusedFlag}
        </if>
        <if test = "confirmUpdateFlag != null">
            AND ph.confirm_update_flag = #{confirmUpdateFlag}
        </if>
        <if test = "supplierName != null and supplierName != ''">
            AND ph.supplier_name = #{supplierName}
        </if>
        <if test = "supplierTenantId != null ">
            <bind name="userDetails" value="@io.choerodon.core.oauth.DetailsHelper@getUserDetails()"/>
            AND (
            CASE
            WHEN ph.supplier_tenant_id IS NULL
            THEN hsesc.tenant_id
            ELSE ph.supplier_tenant_id
            END
            ) = #{userDetails.organizationId}
        </if>
        <if test = "displayPoNum != null and displayPoNum != ''">
            <bind name = "displayPoNumLike" value = "'%'+  displayPoNum + '%'"></bind>
            AND (ph.display_po_num like #{displayPoNumLike} OR ph.po_num like #{displayPoNumLike})
        </if>
        <if test = "ouId != null">
            AND ph.ou_id = #{ouId}
        </if>
        <if test = "purchaseOrgId != null">
            AND ph.purchase_org_id = #{purchaseOrgId}
        </if>
        <if test = "releaseFlag != null">
            AND ph.release_flag = #{releaseFlag}
        </if>
        <if test = "snapshotFlag != null">
            AND ph.snapshot_flag = #{snapshotFlag}
        </if>
        <if test = "erpCreationDateStart != null">
            AND ph.erp_creation_date &gt;= #{erpCreationDateStart}
        </if>
        <if test = "erpCreationDateEnd != null">
            AND ph.erp_creation_date &lt; #{erpCreationDateEnd }
        </if>
        <if test = "creationDateStart != null">
            AND ph.creation_date &gt;= #{creationDateStart}
        </if>
        <if test = "creationDateEnd != null">
            AND ph.creation_date &lt; #{creationDateEnd }
        </if>
        <if test = "publishCancelFlag != null">
            AND ph.publish_cancel_flag = #{publishCancelFlag}
        </if>
        <if test = "cancelledFlag != null">
            AND ph.cancelled_flag = #{cancelledFlag}
        </if>
        <!--        <if test = "statusCode != null and statusCode != ''">-->
        <!--            AND ph.status_code = #{statusCode}-->
        <!--        </if>-->
        <if test = "beyondFlag != null">
            <if test = "beyondFlag == 0">
                AND (
                SELECT
                sum(
                CASE

                WHEN #{nowDate} > spllinfo.promise_delivery_date
                AND phs.confirmed_flag = 1
                AND phs.cancelled_flag = 0
                AND phs.closed_flag = 0
                AND phs.publish_cancel_flag = 0 THEN
                ( CASE spllinfo.quantity WHEN spllinfo.net_received_quantity THEN 0 ELSE 1 END ) ELSE 0
                END
                ) AS receive_status
                FROM
                sodr_po_header phs
                LEFT JOIN sodr_po_line_location spllinfo ON spllinfo.po_header_id = phs.po_header_id
                WHERE
                phs.po_header_id = ph.po_header_id
                ) = #{beyondFlag}
            </if>
            <if test = "beyondFlag == 1">
                AND (
                SELECT
                sum(
                CASE

                WHEN #{nowDate} > spllinfo.promise_delivery_date
                AND phs.confirmed_flag = 1
                AND phs.cancelled_flag = 0
                AND phs.closed_flag = 0
                AND phs.publish_cancel_flag = 0 THEN
                ( CASE spllinfo.quantity WHEN spllinfo.net_received_quantity THEN 0 ELSE 1 END ) ELSE 0
                END
                ) AS receive_status
                FROM
                sodr_po_header phs
                LEFT JOIN sodr_po_line_location spllinfo ON spllinfo.po_header_id = phs.po_header_id
                WHERE
                phs.po_header_id = ph.po_header_id
                ) >= #{beyondFlag}
            </if>
        </if>

        <if test="statusCodes != null and statusCodes.size() > 0">
            <foreach collection = "statusCodes" item = "queryStatus" open = "AND (" close = ")" separator = "OR">
                <choose>
                    <when test="queryStatus == 'PENDING'">
                        ph.status_code = 'PENDING'
                    </when>
                    <when test="queryStatus == 'SUBMITTED'">
                        <if test="queryApprovingFlag != null">
                            ph.status_code = 'SUBMITTED'
                            AND ph.approve_method is null
                            AND ph.closed_flag != 1
                            AND ph.cancelled_flag != 1
                        </if>
                        <if test="queryApprovingFlag == null">
                            (ph.status_code = 'SUBMITTED' OR ph.status_code = 'SUBMITTED_WFL')
                        </if>
                    </when>
                    <when test="queryStatus == 'APPROVED'">
                        ph.status_code = 'APPROVED' AND ph.po_source_platform != 'E-COMMERCE'
                        AND ph.changing_flag != 1
                    </when>
                    <when test="queryStatus == 'REJECTED'">
                        ph.status_code = 'REJECTED'
                        AND ph.changing_flag != 1
                    </when>
                    <when test="queryStatus == 'PUBLISHED'">
                        (ph.status_code = 'PUBLISHED' AND ph.confirmed_flag = 0  AND ph.cancelled_flag = 0 AND ph.closed_flag = 0)
                    </when>
                    <when test="queryStatus == 'DELIVERY_DATE_REVIEW'">
                        (ph.status_code = 'DELIVERY_DATE_REVIEW' AND ph.cancelled_flag = 0 AND ph.closed_flag = 0)
                    </when>
                    <when test="queryStatus == 'DELIVERY_DATE_REJECT'">
                        (ph.status_code = 'DELIVERY_DATE_REJECT'
                        AND ph.changing_flag != 1 AND ph.cancelled_flag = 0 AND ph.closed_flag = 0)
                    </when>
                    <when test="queryStatus == 'CONFIRMED'">
                        (ph.status_code = 'PUBLISHED' AND ph.confirmed_flag = 1 AND ph.publish_cancel_flag = 0 AND ph.cancelled_flag = 0 AND ph.closed_flag = 0)
                    </when>
                    <when test="queryStatus == 'PUBLISH_CANCEL'">
                        (ph.publish_cancel_flag = 1 AND ph.confirmed_flag = 1 AND ph.cancelled_flag = 0 AND ph.closed_flag = 0)
                    </when>
                    <when test="queryStatus == 'CANCELED'">
                        ph.cancelled_flag = 1
                    </when>
                    <when test="queryStatus == 'CLOSED'">
                        (ph.closed_flag = 1 OR ph.status_code='CLOSED')
                    </when>
                    <otherwise>
                        1 = 2
                    </otherwise>
                </choose>
            </foreach>
        </if>

        <!-- 可取消订单查询 净接收数量和净入库数量为0且不存在未取消的送货单行-->
        <if test = "poCancelSelect != null">
            AND NOT EXISTS (
            SELECT
            1
            FROM
            sodr_po_line_location spl,
            sinv_asn_line sal
            WHERE
            sal.po_line_location_id = spl.po_line_location_id
            AND ph.po_header_id = spl.po_header_id
            AND sal.cancelled_flag = 0
            AND sal.closed_flag = 0
            )
            AND NOT EXISTS (
            SELECT
            1
            FROM
            sodr_po_line_location spl
            WHERE
            ph.po_header_id = spl.po_header_id
            AND (spl.net_received_quantity>0
            or spl.net_deliver_quantity>0)
            )
            AND (ph.po_source_platform IS  NULL OR (ph.po_source_platform = 'E-COMMERCE' AND ph.status_code = 'REJECTED')
            OR ph.po_source_platform != 'E-COMMERCE')
            AND ph.source_code = 'SRM'
            AND ph.status_code != 'CANCELED'
            AND ph.cancelled_flag != 1
        </if>

        <!-- 可关闭订单查询 关闭：头状态=已确认，净接收数量!=0 且 不存在未取消/未关闭的送货单行-->
        <if test = "poCloseSelect != null">
            /*且0＜订单的接收数量＜订单数量*/
            AND NOT EXISTS (
            SELECT
            1
            FROM
            sodr_po_line pl
            LEFT JOIN sodr_po_line_location spl ON pl.po_line_id = spl.po_line_id
            WHERE
            pl.po_header_id = ph.po_header_id
            --                 AND ( 0>=spl.net_deliver_quantity
            --                 OR spl.quantity = spl.net_deliver_quantity)
            AND  spl.net_received_quantity=0
            AND spl.closed_flag != 1
            AND spl.cancelled_flag!=1
            )
            /*订单关联的送货单要已关闭*/
            AND NOT EXISTS(
            SELECT
            1
            FROM
            sodr_po_line pl
            LEFT JOIN sodr_po_line_location spl ON pl.po_line_id = spl.po_line_id
            LEFT JOIN sinv_asn_line sal on sal.po_line_location_id= spl.po_line_location_id
            LEFT JOIN sinv_asn_header sah on sah.asn_header_id=sal.asn_header_id
            WHERE
            pl.po_header_id = ph.po_header_id
            and sal.closed_flag!=1
            and sal.cancelled_flag!=1
            )
            AND (ph.po_source_platform IS  NULL OR ph.po_source_platform = 'CATALOGUE' OR ph.po_source_platform = 'SRM' OR ph.po_source_platform = 'SHOP')
            AND ph.source_code = 'SRM'
            AND (ph.status_code = 'PUBLISHED' AND ph.confirmed_flag = 1 AND ph.publish_cancel_flag = 0 AND ph.cancelled_flag = 0 AND ph.closed_flag = 0)
        </if>

        <!-- 流程控制订单查询 -->
        <if test = "poProcessSelect != null">
            AND (ph.po_source_platform IS  NULL OR ph.po_source_platform = 'CATALOGUE' OR ph.po_source_platform = 'SRM' OR ph.po_source_platform = 'SHOP' OR ph.po_source_platform = 'ERP'
            OR (ph.po_source_platform = 'E-COMMERCE' AND ph.status_code = 'REJECTED'))
            AND ph.source_code = 'SRM'
        </if>

        <!-- 查询订单类型 -->
        <if test = "poTypeCode != null and poTypeCode != '' ">
            AND sot.order_type_code = #{poTypeCode}
        </if>
        <if test="closedFlag != null">
            and ph.closed_flag=#{closedFlag}
        </if>
        <if test="evaluationFlag != null">
            and ph.evaluation_flag=#{evaluationFlag}
            and ph.po_source_platform &lt;&gt; 'E-COMMERCE'
        </if>
        <if test="sourceBillTypeCode != null">
            and ph.source_bill_type_code = #{sourceBillTypeCode}
        </if>
    </sql>

</mapper>
